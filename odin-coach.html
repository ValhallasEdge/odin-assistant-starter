<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Odin — Cross‑Realm Coach</title>
<style>
:root{
  --bg:#0b0c12;--panel:#11131d;--line:#2a2d3f;--txt:#e9edff;--sub:#cfd6ff;
  --btn:#17235a;--btn2:#1d2c76;--chip:#121b3a;--chipB:#2c3f9a;--glow:#6ea2ff3a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:880px;margin:14px auto;padding:12px}
.panel{position:relative;border:1px solid var(--line);border-radius:18px;background:var(--panel);box-shadow:0 10px 42px #000a;overflow:hidden}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:linear-gradient(180deg,#151834,#0f1122);border-bottom:1px solid var(--line)}
.title{font-weight:800;letter-spacing:.3px}
.brief{padding:.75rem 1rem;border-bottom:1px dashed var(--line);color:var(--sub)}
.suggest{display:flex;flex-wrap:wrap;gap:.5rem;padding:.6rem 1rem;border-bottom:1px dashed var(--line)}
.chip{background:var(--chip);border:1px solid var(--chipB);color:var(--sub);padding:.38rem .65rem;border-radius:.6rem;cursor:pointer}
.chat{display:flex;flex-direction:column;gap:.6rem;max-height:62vh;overflow:auto;padding:1rem}
.msg{padding:.65rem .8rem;border-radius:.8rem;line-height:1.45;box-shadow:0 1px 6px rgba(0,0,0,.25)}
.bot{background:#111d3a;border:1px solid #2a3566}
.you{background:#17263a;border:1px solid #2a4c66;margin-left:auto}
.form{display:grid;gap:.6rem;padding:0 1rem 1rem}
textarea{background:#0d1020;color:var(--txt);border:1px solid #2a2d3f;border-radius:.8rem;padding:.6rem .75rem;min-height:86px;resize:vertical}
.send{justify-self:end;background:var(--btn2);color:var(--txt);border:1px solid #2f49a0;border-radius:.7rem;padding:.55rem .95rem;cursor:pointer}
@media (max-width:640px){ .chat{max-height:68vh} }

/* subtle runes / nebula (reduced-motion friendly) */
@media (prefers-reduced-motion:no-preference){
  .panel::before, .panel::after{
    content:"";position:absolute;inset:-25% -10% auto -10%;height:42%;pointer-events:none;mix-blend-mode:screen;opacity:.55;
    background: radial-gradient(120px 60px at 10% 60%, #6ea2ff22, transparent 60%),
                radial-gradient(160px 80px at 85% 20%, #6ea2ff14, transparent 60%),
                radial-gradient(100px 60px at 50% 90%, #6ea2ff10, transparent 60%);
    animation: drift 26s linear infinite; filter: blur(1.1px);
  }
  .panel::after{ animation-duration: 34s; opacity:.35; }
  @keyframes drift{ to{ transform: translateY(-14%) } }

  .runes{position:absolute;inset:0;pointer-events:none;color:#6ea2ff18;font-size:42px;letter-spacing:.42em;filter:blur(.4px);
    animation: float 20s linear infinite}
  @keyframes float{ to { transform: translate3d(0,-10%,0) } }
}
</style>
</head>
<body>
<div class="wrap">
  <section class="panel" id="panel">
    <div class="runes" aria-hidden="true">ᚠᚢᚦᚨᚱᚲ ᚷᚹᚺᚾᛁ ᛃᛇᛈᛉᛊ</div>
    <header class="hdr"><div class="title">Odin — Cross‑Realm Counsel</div></header>

    <div class="brief" id="brief">Waiting for your cross‑realm snapshot…</div>

    <div class="suggest">
      <button class="chip" data-q="Set my top two priorities for the next 7 days across realms.">Weekly priorities</button>
      <button class="chip" data-q="Balance heat and cold exposure this week for recovery.">Balance heat/cold</button>
      <button class="chip" data-q="I have limited time—what’s the minimum effective plan?">Minimum effective plan</button>
      <button class="chip" data-q="Travel week: give me portable rituals and micro‑sessions.">Travel week plan</button>
    </div>

    <div class="chat" id="chat" role="log" aria-live="polite"></div>

    <form class="form" id="form">
      <textarea id="input" placeholder="Ask Odin anything about your overall path…" required></textarea>
      <button class="send" type="submit">Ask Odin</button>
    </form>
  </section>
</div>

<script>
(()=> {
  // --- Params & UI ---
  const params = new URLSearchParams(location.search);
  const assistantId = params.get('assistantId') || 'asst_D0BXH8CTZycU0ku9PjkUmW3T'; // default to Odin
  const brief = document.getElementById('brief');
  const chat  = document.getElementById('chat');
  const form  = document.getElementById('form');
  const input = document.getElementById('input');

  // Preset chips
  document.querySelectorAll('.chip').forEach(c=> c.addEventListener('click',()=>{ input.value=c.dataset.q; input.focus(); }));

  // --- Data: parent posts cross‑realm arrays here ---
  let master = null;

  window.addEventListener('message',(ev)=>{
    const d = ev.data || {};
    if(d.type === 've-master'){
      master = buildMaster(d);
      renderBrief();
    }
  });

  function add(t,who='bot'){ const el=document.createElement('div'); el.className='msg'+(who==='you'?' you':' bot'); el.textContent=t; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; }

  function safeLen(s,max=1000){ s = typeof s==='string'? s : JSON.stringify(s||''); return s.length>max? s.slice(0,max)+'…' : s; }

  // Build a compact snapshot Odin can work with
  function buildMaster(d){
    const sum = (arr,sel)=> Array.isArray(arr)? arr.reduce((a,x)=> a+(+sel(x)||0),0) : 0;
    const count = (arr)=> Array.isArray(arr)? arr.length : 0;

    const frostRituals = d.frostRituals || [];
    const fireRituals  = d.fireRituals  || [];
    const runesSessions= d.runesSessions|| [];
    const fitWorkouts  = d.fitWorkouts  || [];
    const feastMeals   = d.feastMeals   || []; // optional future key

    const minutes = a => sum(a, r=> r.duration ?? 0);

    return {
      frost: { sessions: count(frostRituals), minutes: minutes(frostRituals) },
      fire:  { sessions: count(fireRituals),  minutes: minutes(fireRituals)  },
      runes: { sessions: count(runesSessions),minutes: minutes(runesSessions) },
      fitness:{ sessions: count(fitWorkouts), minutes: minutes(fitWorkouts)   },
      feast: { sessions: count(feastMeals),   minutes: minutes(feastMeals)    },
      weekHint: d.weekHint || null
    };
  }

  function renderBrief(){
    if(!master){ brief.textContent = 'No data yet — Odin will orient you once stats arrive.'; return; }
    brief.textContent = 'Snapshot received — Odin is ready.';
  }

  // --- Threads & Prompt ---
  const threadKey = (assistantId)=> `valhalla_thread_${assistantId}`;
  async function getThread(){
    let id = localStorage.getItem(threadKey(assistantId));
    if(id && id.startsWith('thread_')) return id;
    const r = await fetch('/api/start-thread',{method:'POST',headers:{'Content-Type':'application/json'}});
    const j = await r.json();
    if(j.threadId){ localStorage.setItem(threadKey(assistantId), j.threadId); return j.threadId; }
    throw new Error('No threadId');
  }

  function buildPrompt(q){
    const safety = 'Stay practical and non-clinical. Favor balance across realms and minimal effective doses when appropriate.';
    const rules = `You are Odin, giving cross‑realm counsel. ${safety}
Respond concisely:
1) One‑sentence orientation.
2) Two numbered priorities for the next 7 days.
3) One unifying ritual that ties realms together.
4) Safety reminder.`;

    const snap = master ? safeLen(JSON.stringify(master), 1000) : '[none]';
    const question = q || 'Set my 7‑day cross‑realm priorities based on the snapshot.';

    return `${rules}\n[Snapshot]\n${snap}\n\n[User]\n${question}`;
  }

  // --- Send ---
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const q = input.value.trim(); if(!q) return;
    add(q,'you'); input.value=''; add('Odin considers your path…');
    try{
      const threadId = await getThread();
      const r = await fetch('/api/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ assistantId, message: buildPrompt(q), threadId })
      });
      const j = await r.json();
      chat.lastChild.textContent = j.reply || '…';
    }catch(err){
      console.error(err);
      chat.lastChild.textContent = 'Odin is silent. Try again later.';
    }
  });

  renderBrief();
})();
</script>
</body>
</html>
