<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Valhalla Pantheon â€“ Valhalla Coach</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{
    --brand:#ffe18d;                 /* selected-god accent */
    --ink:#f8e6c3;
    --ring:#2a2a2a;
    --soft: rgba(255,225,141,.14);

    --card-w: min(96vw, 880px);
    --card-pad: 26px 18px 16px;
    --reply-min-h: clamp(120px, 18vh, 180px);

    /* thinking rune speeds (in seconds per full turn) */
    --idle-spin-s: 6s;               /* slightly faster idle than before */
    --think-spin-s: 2.2s;            /* initial thinking speed (will ramp down dynamically) */
  }

  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background: transparent; /* let Shopify page show through */
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding: max(env(safe-area-inset-top), 0) 0 max(env(safe-area-inset-bottom), 12px);
  }

  /* ======= FULL-WIDTH CAROUSEL BAR ======= */
  .pantheon-bar{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.2));
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid #26231a;
  }
  .rail{
    height: 106px;
    display:flex; align-items:center; gap:18px;
    overflow-x:auto; overflow-y:hidden;
    overscroll-behavior-x: contain;
    -webkit-overflow-scrolling: touch;
    padding: 10px 18px;
    scroll-snap-type:x proximity;
    mask-image: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent 100%);
    -webkit-mask-image: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent 100%);
  }
  .rail::-webkit-scrollbar{ height:10px }
  .rail::-webkit-scrollbar-thumb{ background:#3b3422; border-radius:100px }

  .chip{
    --hover:#ffe18d;                 /* set inline per god */
    flex: 0 0 auto;
    width:92px; height:92px;
    border-radius:999px;
    border:3px solid var(--ring);
    background:#000;
    overflow:hidden;
    cursor:pointer;
    scroll-snap-align:center;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease, opacity .18s ease;
    transform: perspective(900px) rotateY(var(--rotY,0deg)) translateY(var(--dy,0px)) scale(var(--sc,1));
    opacity: var(--op,1);
    will-change: transform, opacity;
    backface-visibility: hidden;
  }
  .chip img{
    width:100%; height:100%; object-fit:cover; object-position: top center;
    border-radius:inherit; display:block;
  }
  .chip:hover{
    border-color:var(--hover);
    box-shadow:0 0 18px 2px color-mix(in srgb, var(--hover) 55%, transparent);
    filter: saturate(1.08);
  }
  .chip[data-selected="true"]{
    transform: perspective(900px) rotateY(var(--rotY,0deg)) translateY(var(--dy,0px)) scale(calc(var(--sc,1) + .08));
    border-color:var(--brand);
    box-shadow:0 0 22px 3px color-mix(in srgb, var(--brand) 65%, transparent), inset 0 0 0 3px rgba(0,0,0,.45);
  }

  /* ======= CARD ======= */
  .card{
    position:relative;
    width: var(--card-w);
    margin: 14px auto 22px;
    padding: var(--card-pad);
    border-radius:24px;
    border:2px solid var(--brand);
    background: linear-gradient(180deg, rgba(18,18,18,.82), rgba(16,16,16,.76));
    box-shadow: 0 16px 70px rgba(0,0,0,.55), 0 0 40px 2px rgba(255,225,141,.05);
    z-index:10; /* above sticky rail */
    overflow:hidden; /* contain background sprites */
  }

  /* God-tinted space: tiny stars + faint runes fading in/out (no drift) */
  .space{
    position:absolute; inset:0; z-index:0; pointer-events:none;
    /* base speckle via subtle gradients */
    background:
      radial-gradient(1px 1px at 20% 30%, color-mix(in srgb, var(--brand) 28%, transparent), transparent 60%),
      radial-gradient(1px 1px at 70% 60%, color-mix(in srgb, var(--brand) 24%, transparent), transparent 60%),
      radial-gradient(1px 1px at 40% 80%, color-mix(in srgb, var(--brand) 22%, transparent), transparent 60%),
      radial-gradient(1px 1px at 85% 25%, color-mix(in srgb, var(--brand) 26%, transparent), transparent 60%),
      radial-gradient(1px 1px at 10% 70%, color-mix(in srgb, var(--brand) 22%, transparent), transparent 60%);
    opacity: .30;
  }
  .star{
    position:absolute; width:2px; height:2px; border-radius:50%;
    background: color-mix(in srgb, var(--brand) 85%, white);
    opacity:.0; animation: twinkle linear infinite;
  }
  @keyframes twinkle{
    0%,100%{ opacity: .0 }
    50%{ opacity: .55 }
  }
  .rune-sprite{
    position:absolute; font-weight:800; color: color-mix(in srgb, var(--brand) 92%, transparent);
    opacity:.0; user-select:none;
    backface-visibility:hidden;
    animation: pulse ease-in-out infinite;
  }
  @keyframes pulse{
    0%,100%{ opacity: .0; transform: scale(0.98) }
    50%{ opacity: .14; transform: scale(1.02) }
  }

  #god-logo{
    position:relative; z-index:1;
    width:132px; height:132px; border-radius:50%;
    object-fit:cover; object-position: top center;
    border:4px solid var(--brand);
    box-shadow: 0 0 20px 2px var(--soft), inset 0 0 18px rgba(0,0,0,.5);
    display:block; margin: 6px auto 8px;
  }
  #god-title{
    position:relative; z-index:1;
    text-align:center; font-family:Montserrat,Inter,sans-serif; font-weight:700; letter-spacing:2px;
    font-size: clamp(1.35rem, 1.1rem + 1.2vw, 2.1rem);
    color: var(--brand);
    text-shadow: 0 2px 14px rgba(0,0,0,.35);
    margin: 0 0 4px;
  }
  #god-bio{
    position:relative; z-index:1;
    text-align:center; color:#f3ebd7;
    margin: 0 10px 12px; font-size: clamp(.98rem, .92rem + .4vw, 1.12rem);
  }

  /* ======= RUIN TOKENS (top): coin ======= */
  .tokens{
    position:relative; z-index:1;
    display:flex; gap:10px; align-items:center; justify-content:center;
    margin: 8px 0 12px;
    font-weight:700; color:#ffefae;
  }
  .coin{
    width:26px; height:26px; display:inline-grid; place-items:center;
    animation: coinFlip 7.5s linear infinite;
    transform-style:preserve-3d; backface-visibility:hidden;
  }
  @keyframes coinFlip{ to{ transform: rotateY(1turn); } }
  .coin svg{ display:block; width:100%; height:100% }
  .coin .face{ filter: drop-shadow(0 0 3px rgba(255,225,141,.18)); }

  /* ======= CHAT ======= */
  .history{
    position:relative; z-index:1;
    border:1px solid #29281e;
    border-radius:14px;
    padding: 12px 12px;
    min-height: var(--reply-min-h);
    max-height: clamp(240px, 44vh, 540px);
    overflow-y: auto;
    background: rgba(5,5,5,.30);
    -webkit-backdrop-filter: blur(2.5px);
    backdrop-filter: blur(2.5px);
    box-shadow: inset 0 0 0 1px rgba(255,225,141,.06), 0 6px 30px rgba(0,0,0,.25);
  }
  .history .msg{ margin: 8px 0; line-height:1.5 }
  .history .user{ color:#bfefff; text-align:right }
  .history .god{ color:var(--brand) }

  /* ======= THINKING RUNE (bigger + ramping acceleration) ======= */
  .thinking{
    position:relative; z-index:1;
    display:flex; align-items:center; justify-content:center;
    height:54px; margin:14px 0 10px;
  }
  .thinking .rune{
    width:48px; height:48px; display:grid; place-items:center;
    font-size:30px; font-weight:900; line-height:1;
    color:#ffe18d;
    -webkit-text-stroke: 1px #7a611f;
            text-stroke: 1px #7a611f;
    text-shadow: 0 0 6px rgba(255,225,141,.18);
    transform-style:preserve-3d; backface-visibility:hidden;
    animation: runeSpin var(--idle-spin-s) linear infinite;
    user-select:none;
  }
  .thinking[data-state="thinking"] .rune{
    animation-duration: var(--think-spin-s);
  }
  @keyframes runeSpin{ to{ transform: rotateY(1turn); } }

  /* ======= INPUT ======= */
  .input-row{
    position:relative; z-index:1;
    display:grid; grid-template-columns: 1fr auto; gap:10px;
    margin: 12px 0 6px;
  }
  .input-row input{
    background:#1d1d1d; border:1px solid #2b2b2b; color:#fff;
    border-radius:14px; font-size:1.02rem; padding:12px 14px; min-width:0;
    outline:none;
  }
  .input-row button{
    background: var(--brand); color:#231f15; border:0; border-radius:14px;
    font-weight:800; padding: 12px 18px; cursor:pointer;
    font-family:Montserrat,Inter,sans-serif;
    box-shadow: 0 6px 18px rgba(255,225,141,.20);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .input-row button:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(255,225,141,.28) }

  /* Focus rings */
  .chip:focus-visible, .input-row input:focus-visible, .input-row button:focus-visible{
    outline: 2px solid color-mix(in srgb, var(--brand) 80%, #fff);
    outline-offset: 3px; border-radius:14px;
  }

  /* ======= RESPONSIVE ======= */
  @media(max-width: 640px){
    .rail{ height: 96px; gap:14px; padding:8px 12px }
    .chip{ width:80px; height:80px; border-width:2.5px }
    .card{ width: min(96vw, 560px); margin-top: 12px; padding: 22px 14px 14px }
    #god-logo{ width:118px; height:118px }
    .input-row{ grid-template-columns: 1fr; }
    .input-row button{ width:100% }
  }
  @media(min-width: 1024px){
    .rail{ height: 116px }
    .chip{ width:96px; height:96px }
  }

  /* Pause animations via .paused (IntersectionObserver) */
  .paused .coin, .paused .rune, .paused .star, .paused .rune-sprite{ animation-play-state: paused !important; }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    .coin, .rune, .star, .rune-sprite { animation: none !important }
  }
</style>
</head>
<body>

<header class="pantheon-bar">
  <div id="rail" class="rail" aria-label="Choose your guide"></div>
</header>

<main class="card" id="card">
  <!-- god-tinted space background (stars + faint runes) -->
  <div class="space" id="space"></div>

  <img id="god-logo" alt="Guide portrait" src="" />
  <div id="god-title"></div>
  <div id="god-bio"></div>

  <div class="tokens" aria-live="polite">
    <span id="tokenCoin" class="coin" aria-hidden="true">
      <!-- Gold coin with rune on face -->
      <svg viewBox="0 0 64 64" role="img" aria-label="Ruin coin">
        <defs>
          <radialGradient id="goldGrad" cx="50%" cy="50%" r="60%">
            <stop offset="0%" stop-color="#fff6d1"/>
            <stop offset="45%" stop-color="#ffd86b"/>
            <stop offset="100%" stop-color="#b58623"/>
          </radialGradient>
        </defs>
        <circle class="face" cx="32" cy="32" r="28" fill="url(#goldGrad)" stroke="#8a651a" stroke-width="3"/>
        <circle cx="32" cy="32" r="22" fill="none" stroke="#fff0b0" stroke-opacity=".5" stroke-width="2"/>
        <text id="coinRune" x="32" y="39" text-anchor="middle" font-size="24" font-family="serif" fill="#7a4c00">áš±</text>
      </svg>
    </span>
    <span>Ruin Tokens Remaining:&nbsp;<span id="ruin-tokens">10</span></span>
  </div>

  <section id="history" class="history" aria-live="polite" aria-busy="false">
    <div class="msg god">Ask your guide anythingâ€¦</div>
  </section>

  <!-- Thinking rune (bigger; ramps speed & rune-change rate on Send) -->
  <div id="thinking" class="thinking" data-state="idle">
    <span id="thinkingRune" class="rune" aria-hidden="true">áš </span>
  </div>

  <form id="chat-form" class="input-row" autocomplete="off">
    <input id="chat-input" placeholder="Ask your guide anythingâ€¦" />
    <button type="submit" id="sendBtn">Send</button>
  </form>
</main>

<script>
/* ---------- Data ---------- */
const GODS = [
  { key:'odin', name:'Odin',     assistantId:'asst_D0BXH8CTZycU0ku9PjkUmW3T', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/mimir-icon.jpg?v=1752795592', color:'#1c64ff', bio:'Wisdom, vision, and strategyâ€”the Allfather.', startRune:'áš¨' },
  { key:'thor', name:'Thor',     assistantId:'asst_JNie4vDtknbropUsbuXF4OpG', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Thor_-God-of-Thunder_-Icon.jpg?v=1752622811', color:'#e14b3d', bio:'Strength, action, and resilienceâ€”the thunder god.', startRune:'áš¦' },
  { key:'loki', name:'Loki',     assistantId:'asst_hKdLlIlE66bKCjuuDzhwknFM', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Loki_-God-of-Mischief_-Icon.jpg?v=1752622811', color:'#0db18a', bio:'Creativity, wit, and transformationâ€”the trickster.', startRune:'á›š' },
  { key:'freya',name:'Freya',    assistantId:'asst_A0oRwWmYijWwmRJuA2iO9JlR', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Freya_-Icon.jpg?v=1752622811',               color:'#c5277e', bio:'Healing, beauty, and abundanceâ€”the goddess of love.', startRune:'áš ' },
  { key:'oz',   name:'Oz',       assistantId:'asst_Hk4WoxgaWQr5wbagpEtmQbuY', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Oz_-Icon.jpg?v=1752623378',                 color:'#ff9200', bio:'Transformation, wisdom, and masteryâ€”the digital wizard.', startRune:'áš·' },
  { key:'tyr',  name:'Tyr',      assistantId:'asst_5RBZdhN1br4dkpDB6g1cRBCg', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/tyr---icon.jpg?v=1752803717',                 color:'#946140', bio:'Justice, discipline, and sacrificeâ€”the steadfast champion.', startRune:'á›' },
  { key:'heimdall', name:'Heimdall', assistantId:'asst_5BTp4L16s3LSFZWyOwHL2Qow', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/heimdall_-icon.jpg?v=1752622811',       color:'#8653eb', bio:'Clarity, vigilance, and protectionâ€”the ever-watchful guardian.', startRune:'ášº' },
  { key:'skald',name:'Skald',    assistantId:'asst_mDsnxmXYWK6VVR2TGlWgr0Db', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Skald_-Icon.jpg?v=1752623003',               color:'#2b55e2', bio:'Story, poetry, and inspirationâ€”the bard of legend.', startRune:'á›ƒ' },
  { key:'coach',name:'Valhalla Coach', assistantId:'asst_0b7Qdwscxs168I4YFX2gKSUd', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Valhalla-Coach-Icon.jpg?v=1752623891',color:'#ffe18d', bio:'Motivation, discipline, and actionâ€”your ultimate Viking coach.', startRune:'á›' }
];

const RUNE_SET = ['áš ','áš¢','áš¦','áš¨','áš±','áš·','áš¹','ášº','áš¾','á›','á›ƒ','á›‡','á›‰'];

/* ---------- Elements ---------- */
const rail = document.getElementById('rail');
const card = document.getElementById('card');
const space = document.getElementById('space');
const logo = document.getElementById('god-logo');
const titleEl = document.getElementById('god-title');
const bioEl = document.getElementById('god-bio');
const hist = document.getElementById('history');
const form = document.getElementById('chat-form');
const input = document.getElementById('chat-input');
const sendBtn = document.getElementById('sendBtn');
const thinking = document.getElementById('thinking');
const thinkingRune = document.getElementById('thinkingRune');

const tokenCoin = document.getElementById('tokenCoin');
const coinRune = document.getElementById('coinRune');
const tokenEl = document.getElementById('ruin-tokens');

const params = new URLSearchParams(location.search);
const fromURL = (params.get('god')||'').toLowerCase();
let selected = GODS.find(g=>g.key.toLowerCase()===fromURL) || GODS.find(g=>g.key==='coach');
let chatHistory = [];

/* ---------- Helpers ---------- */
const isDesktop = matchMedia('(hover: hover) and (pointer: fine)').matches;
function setTheme(color){ document.documentElement.style.setProperty('--brand', color || '#ffe18d'); }
function hexToSoft(hex){ try{ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16); return `rgba(${r},${g},${b},0.38)`; }catch{ return 'rgba(255,225,141,.38)'; }}
function safeHTML(md){
  const raw = marked.parse(md || '');
  const tmp = document.createElement('div'); tmp.innerHTML = raw;
  const ALLOW_TAGS = new Set(['P','EM','STRONG','UL','OL','LI','A','BR','CODE','PRE','BLOCKQUOTE']);
  const ALLOW_ATTR = { 'A': new Set(['href','title','target','rel']) };
  const walk = (node)=>{
    [...node.children].forEach(el=>{
      if(!ALLOW_TAGS.has(el.tagName)){ el.replaceWith(document.createTextNode(el.textContent)); return; }
      [...el.attributes].forEach(a=>{
        if(el.tagName==='A' && ALLOW_ATTR['A'].has(a.name)){
          if(a.name==='href' && !/^https?:/i.test(a.value)) el.removeAttribute('href');
          if(a.name==='target'){ el.setAttribute('rel','noopener'); }
        }else{ el.removeAttribute(a.name); }
      });
      walk(el);
    });
  };
  walk(tmp);
  return tmp.innerHTML;
}

/* ---------- Build carousel rail ---------- */
function buildRail(){
  rail.innerHTML='';
  const list = isDesktop ? [...GODS, ...GODS] : [...GODS]; // â€œinfiniteâ€ feel on desktop
  list.forEach(g=>{
    const chip = document.createElement('button');
    chip.type='button';
    chip.className='chip';
    chip.title = g.name;
    chip.dataset.key = g.key;
    chip.dataset.selected = (g.key===selected.key);
    chip.style.setProperty('--hover', g.color);
    chip.setAttribute('aria-label', g.name);

    const img = document.createElement('img');
    img.alt = g.name; img.src = g.avatar; img.loading = 'lazy';
    chip.appendChild(img);

    chip.addEventListener('mouseenter', ()=> chip.style.boxShadow=`0 0 18px 2px ${hexToSoft(g.color)}`);
    chip.addEventListener('mouseleave', ()=> chip.style.boxShadow='none');
    chip.addEventListener('click', ()=> selectGod(g.key));
    rail.appendChild(chip);
  });
  centerOnSelected();
  applyTaper();
}

/* ---------- Taper (outer 1â€“2 only), readable faces ---------- */
function applyTaper(){
  const center = rail.scrollLeft + rail.clientWidth/2;
  const maxDist = rail.clientWidth * .62;
  const edgeStart = 0.78;
  const minOpacity = 0.85;

  [...rail.children].forEach(ch=>{
    const mid = ch.offsetLeft + ch.clientWidth/2;
    const dist = Math.abs(mid - center);
    const t = Math.min(dist / maxDist, 1);

    const scale = 1 - 0.08 * t;
    let opacity = 1, tilt = 0, dy = 0;

    if (t > edgeStart){
      const f = (t - edgeStart) / (1 - edgeStart);
      opacity = Math.max(minOpacity, 1 - 0.20 * f);
      tilt = (mid < center ? -1 : 1) * (10 + 8*f);
      dy = 6 * f;
    }

    ch.style.setProperty('--sc', scale.toFixed(3));
    ch.style.setProperty('--op', opacity.toFixed(3));
    ch.style.setProperty('--rotY', tilt.toFixed(1)+'deg');
    ch.style.setProperty('--dy', dy.toFixed(1)+'px');
  });
}

/* Desktop auto-glide; Mobile = native scroll (no jitter) */
let rafId=null, inView=true;
function startDesktopAuto(){
  if(!isDesktop || !inView) return;
  function tick(){
    rail.scrollLeft += 0.25;
    if(rail.scrollLeft > rail.scrollWidth/2){ rail.scrollLeft = 0; }
    applyTaper();
    rafId = requestAnimationFrame(tick);
  }
  rafId = requestAnimationFrame(tick);
}
function stopDesktopAuto(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }
if(isDesktop){
  ['mouseenter','mousedown','focusin','touchstart'].forEach(ev=>{
    rail.addEventListener(ev, ()=> stopDesktopAuto(), {passive:true});
  });
  ['mouseleave','mouseup','blur','touchend'].forEach(ev=>{
    rail.addEventListener(ev, ()=> startDesktopAuto(), {passive:true});
  });
}
let scrollTick=false;
rail.addEventListener('scroll', ()=>{
  if(!scrollTick){ scrollTick=true; requestAnimationFrame(()=>{ applyTaper(); scrollTick=false; }); }
},{passive:true});
function centerOnSelected(){
  const chip = [...rail.children].find(el=>el.dataset.key===selected.key);
  if(chip){ rail.scrollLeft = chip.offsetLeft - (rail.clientWidth - chip.clientWidth)/2; }
}

/* ---------- Space background: tiny stars + faint pulsing runes ---------- */
function buildSpace(){
  // clear
  space.innerHTML = '';
  // stars
  const starCount = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 0 : 28;
  for(let i=0;i<starCount;i++){
    const s=document.createElement('i');
    s.className='star';
    s.style.left = Math.round(Math.random()*98)+'%';
    s.style.top  = Math.round(Math.random()*98)+'%';
    s.style.animationDuration = (3 + Math.random()*4)+'s'; // 3â€“7s
    s.style.animationDelay = (Math.random()*5)+'s';
    space.appendChild(s);
  }
  // faint runes pulsing in/out
  const runeCount = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 0 : 6;
  for(let i=0;i<runeCount;i++){
    const r=document.createElement('div');
    r.className='rune-sprite';
    r.textContent = RUNE_SET[(i*3 + 2) % RUNE_SET.length];
    r.style.left = Math.round(Math.random()*86 + 7)+'%';
    r.style.top  = Math.round(Math.random()*70 + 10)+'%';
    r.style.fontSize = (10 + Math.random()*22)+'px';
    r.style.animationDuration = (8 + Math.random()*16)+'s'; // 8â€“24s
    r.style.animationDelay = (Math.random()*8)+'s';
    space.appendChild(r);
  }
}

/* ---------- Select & render ---------- */
function renderCard(){
  logo.src = selected.avatar;
  titleEl.textContent = selected.name;
  bioEl.textContent = selected.bio;
  setTheme(selected.color);
  input.placeholder = `Ask ${selected.name} anythingâ€¦`;
  thinkingRune.textContent = selected.startRune || 'áš ';
  thinking.dataset.state = 'idle';
  document.documentElement.style.setProperty('--idle-spin-s','6s');
  document.documentElement.style.setProperty('--think-spin-s','2.2s');
  [...rail.children].forEach(ch=> ch.dataset.selected = (ch.dataset.key===selected.key));
  buildSpace();
}

function storageKey(g){ return `valhalla_thread_${g}`; }
async function getOrCreateThread(g){
  const k = storageKey(g);
  const existing = localStorage.getItem(k);
  if(existing && existing.startsWith('thread_')) return existing;
  try{
    const res = await fetch('https://odin-assistant-starter.vercel.app/api/start-thread', {method:'POST', headers:{'Content-Type':'application/json'}});
    const data = await res.json();
    if(data.threadId && data.threadId.startsWith('thread_')){ localStorage.setItem(k, data.threadId); return data.threadId; }
  }catch(e){ console.error(e); }
  return null;
}

function renderHistory(){
  hist.innerHTML = chatHistory.length
    ? chatHistory.map(m=>`<div class="msg ${m.from==='user'?'user':'god'}">${safeHTML(m.text || '')}</div>`).join('')
    : `<div class="msg god">Ask your guide anythingâ€¦</div>`;
  hist.scrollTop = hist.scrollHeight;
}
function selectGod(key){
  const g = GODS.find(x=>x.key===key) || selected;
  selected = g;
  renderCard();
  chatHistory = [];
  renderHistory();
  getOrCreateThread(g.key);
}

/* ---------- Thinking rune: acceleration ramp (spin + glyph rate) ---------- */
let runeCycleTimer=null;
let accelTimer=null;
let currentSpinS = 2.2;        // starts at 2.2s per turn when thinking
const minSpinS = 1.2;         // do not get unreadably fast
let currentGlyphInterval = 260; // ms between rune changes when thinking
const minGlyphInterval = 120;

function setRuneCycleInterval(ms){
  if(runeCycleTimer) clearInterval(runeCycleTimer);
  runeCycleTimer = setInterval(()=>{
    const curr = thinkingRune.textContent;
    const idx = (RUNE_SET.indexOf(curr)+1+RUNE_SET.length)%RUNE_SET.length;
    thinkingRune.textContent = RUNE_SET[idx];
  }, ms);
}

function startAcceleration(){
  stopAcceleration(); // clean slate
  // set initial fast-but-readable cadence
  currentSpinS = 2.2;
  currentGlyphInterval = 260;
  document.documentElement.style.setProperty('--think-spin-s', currentSpinS+'s');
  setRuneCycleInterval(currentGlyphInterval);
  thinking.dataset.state = 'thinking';
  hist.setAttribute('aria-busy','true');

  // every 600ms, nudge faster until floor values
  accelTimer = setInterval(()=>{
    // spin faster (reduce seconds per rotation)
    currentSpinS = Math.max(minSpinS, +(currentSpinS - 0.18).toFixed(2));
    document.documentElement.style.setProperty('--think-spin-s', currentSpinS+'s');

    // glyph swap faster
    currentGlyphInterval = Math.max(minGlyphInterval, currentGlyphInterval - 18);
    setRuneCycleInterval(currentGlyphInterval);

    // if both floors reached, stop ramp but keep running until reply
    if(currentSpinS === minSpinS && currentGlyphInterval === minGlyphInterval){
      clearInterval(accelTimer); accelTimer=null;
    }
  }, 600);
}
function stopAcceleration(){
  if(accelTimer){ clearInterval(accelTimer); accelTimer=null; }
  if(runeCycleTimer){ clearInterval(runeCycleTimer); runeCycleTimer=null; }
  // return to idle
  thinking.dataset.state = 'idle';
  hist.setAttribute('aria-busy','false');
  document.documentElement.style.setProperty('--idle-spin-s','6s');
}

/* ---------- Form submit ---------- */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const t = (input.value||'').trim();
  if(!t) return;

  if(decrementToken() <= 0){ alert("ðŸ›‘ Youâ€™re out of Ruin Tokens. Come back tomorrow or earn more."); return; }

  chatHistory.push({from:'user', text:t});
  renderHistory();
  input.value='';

  startAcceleration();

  try{
    const threadId = await getOrCreateThread(selected.key);
    if(!threadId) throw new Error('no-thread');

    const res = await fetch('https://odin-assistant-starter.vercel.app/api/chat', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ assistantId: selected.assistantId, message: t, threadId })
    });
    const data = await res.json();

    chatHistory.push({from:'god', text: data.reply || 'No reply from the gods.'});
    renderHistory();
  }catch(err){
    console.error(err);
    chatHistory.push({from:'god', text:'âš ï¸ Network error. Please try again.'});
    renderHistory();
  }finally{
    stopAcceleration();
  }
});

/* ---------- Token coin: change rune each full flip ---------- */
let coinIdx = 4; // start áš±
tokenCoin.addEventListener('animationiteration', ()=>{
  coinIdx = (coinIdx + 1) % RUNE_SET.length;
  coinRune.textContent = RUNE_SET[coinIdx];
});

/* ---------- Keyboard niceties ---------- */
document.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowRight'){ rail.scrollBy({left:110, behavior:'smooth'}); }
  if(e.key==='ArrowLeft'){ rail.scrollBy({left:-110, behavior:'smooth'}); }
  if(e.key==='Escape'){ input.blur(); }
});

/* ---------- Ruin tokens (daily) ---------- */
const DAILY_LIMIT=10, TOKEN_KEY="valhalla_tokens", DATE_KEY="valhalla_last_date";
function today(){ return new Date().toISOString().slice(0,10); }
function resetDaily(){ localStorage.setItem(TOKEN_KEY, DAILY_LIMIT); localStorage.setItem(DATE_KEY, today()); updateTokens(); }
function updateTokens(){ tokenEl.textContent = Number.parseInt(localStorage.getItem(TOKEN_KEY)||'0'); }
function checkReset(){ const last = localStorage.getItem(DATE_KEY); if(last !== today()) resetDaily(); updateTokens(); }
function decrementToken(){ let t=Number.parseInt(localStorage.getItem(TOKEN_KEY)||'0'); if(t>0){ t--; localStorage.setItem(TOKEN_KEY,t); } updateTokens(); return t; }

/* ---------- IntersectionObserver: pause when off-screen ---------- */
const io = new IntersectionObserver((entries)=>{
  entries.forEach(entry=>{
    inView = entry.isIntersecting;
    card.classList.toggle('paused', !inView);
    if(inView) startDesktopAuto(); else stopDesktopAuto();
  });
},{threshold: 0.15});
io.observe(card);

/* ---------- Init ---------- */
(function init(){
  buildRail();
  setTheme(selected.color);
  renderCard();
  renderHistory();
  checkReset();
  if(isDesktop) startDesktopAuto();
  setTimeout(()=> input.focus(), 150);
})();
</script>
</body>
</html>
