<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OdinAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Fonts: Montserrat for modern sans, EB Garamond for Norse serif -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=EB+Garamond:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #17223b;
      --rune: #405985;
      --odin-gold: #b8a25a;
      --odin-shadow: 0 6px 32px 0 #4059851a;
      --bg-main: #f6f8fb;
      --bg-card: #fff;
      --bg-runic: #f5f7fa;
      --bg-loader: #eaf0f7f0;
      --odin-burgundy: #912e2e;
      --blue-gradient: linear-gradient(90deg, #4067b5 0%, #3a4963 100%);
      --send-shadow: 0 2px 12px #40598522;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', 'EB Garamond', serif;
      background: radial-gradient(ellipse at 55% 10%, #f5f7fa 65%, #e5eaf3 100%);
      min-height: 100vh;
    }
    body {
      min-height: 100vh;
    }
    .valhalla-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: none;
      padding-bottom: 60px;
    }
    .chat-panel {
      margin-top: 48px;
      background: var(--bg-card);
      border-radius: 36px;
      box-shadow: var(--odin-shadow);
      max-width: 540px;
      width: 95vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 0 18px 0;
      position: relative;
      z-index: 2;
    }
    .valhalla-logo {
      width: 92px;
      height: 92px;
      background: var(--bg-card);
      margin: -52px auto 8px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      box-shadow: 0 6px 24px 0 #0001;
      border: 4px solid var(--bg-main);
      position: absolute;
      left: 50%;
      top: -46px;
      transform: translateX(-50%);
      z-index: 10;
      overflow: visible;
    }
    .valhalla-logo img {
      width: 84px;
      height: 84px;
      object-fit: contain;
      border-radius: 50%;
      box-shadow: 0 3px 16px 0 #1a191b1f;
      background: #141516;
    }
    .runes-row {
      text-align: center;
      letter-spacing: 0.3em;
      color: #b6bac8;
      font-size: 2em;
      font-family: 'EB Garamond', serif;
      opacity: 0.22;
      margin-top: 38px;
      margin-bottom: 10px;
      user-select: none;
      font-weight: 600;
      width: 100%;
    }
    .ask-odin-header {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.8em;
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.05em;
      margin: 8px 0 2px 0;
      position: relative;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ask-odin-header .odin-o {
      color: var(--rune);
      display: inline-block;
      transition: 0.2s;
      font-family: inherit;
      font-weight: bold;
      position: relative;
      cursor: pointer;
    }
    .ask-odin-header .odin-o .rune {
      display: none;
      font-family: 'EB Garamond', serif;
      font-size: 1.0em;
      color: var(--odin-burgundy);
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-54%, -62%) scale(1.4);
      pointer-events: none;
      letter-spacing: 0;
    }
    .ask-odin-header .odin-o:hover .letter { opacity: 0; }
    .ask-odin-header .odin-o:hover .rune { display: inline; }
    .odin-underline {
      width: 230px;
      max-width: 70vw;
      margin: 0 auto 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 22px;
      position: relative;
    }
    .odin-underline svg {
      width: 100%;
      height: 24px;
      display: block;
    }
    .odin-desc {
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.09em;
      color: #707487;
      font-weight: 400;
      letter-spacing: 0.02em;
      margin-bottom: 9px;
    }
    .music-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 98%;
      gap: 0.4em;
      margin-bottom: -32px;
      margin-top: 10px;
      position: relative;
    }
    .music-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      color: var(--odin-gold);
      cursor: pointer;
      margin-right: 8px;
      transition: color 0.15s;
      position: relative;
    }
    .music-btn.playing { color: #5ab3de; }
    .music-btn:active { color: #244e68; }
    .music-slider {
      accent-color: var(--odin-gold);
      width: 94px;
      height: 5px;
      vertical-align: middle;
      margin-left: 2px;
      margin-top: 2px;
    }
    .chat-card {
      width: 98%;
      margin: 16px auto 0 auto;
      background: #fdfdfb;
      border-radius: 18px;
      box-shadow: 0 1px 16px 0 #40598512;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 320px;
      max-height: 375px;
      overflow: hidden;
      position: relative;
    }
    .chat-messages {
      padding: 1.4em 1.4em 0.5em 1.4em;
      flex: 1 1 auto;
      overflow-y: auto;
      font-size: 1.07em;
      line-height: 1.7;
      background: none;
      color: #2b2d38;
      font-family: 'EB Garamond', serif;
    }
    .msg-block {
      margin-bottom: 1.7em;
      word-break: break-word;
    }
    .msg-user {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1em;
      color: var(--rune);
      background: #e8eefa;
      padding: 0.37em 1em;
      border-radius: 14px 14px 0 0;
      margin-bottom: 0.33em;
      border-left: 4px solid var(--rune);
      box-shadow: 0 1px 8px #4059850d;
      display: inline-block;
    }
    .msg-odin {
      font-family: 'EB Garamond', serif;
      font-size: 1.08em;
      color: #1a1a1a;
      background: #fefaf1;
      border-left: 5px solid var(--odin-gold);
      border-radius: 0 0 16px 8px;
      margin-bottom: 1.2em;
      padding: 0.7em 1.15em 0.7em 1.25em;
      min-height: 48px;
      box-shadow: 0 0 8px #b8a25a07;
    }
    .msg-odin strong {
      color: var(--odin-gold);
      font-weight: 700;
      font-family: 'Montserrat', sans-serif;
      letter-spacing: 0.04em;
    }
    .msg-odin em, .msg-odin i {
      color: var(--rune);
      font-style: italic;
    }
    .msg-odin .odin-highlight {
      color: var(--odin-burgundy);
      font-weight: bold;
      font-family: 'Montserrat', sans-serif;
    }
    .msg-odin .odin-pop {
      color: #1c6cc7;
      font-weight: 700;
    }
    .chat-input-row {
      width: 97%;
      margin: 0 auto;
      margin-top: 0.5em;
      display: flex;
      align-items: stretch;
      gap: 0.5em;
      position: relative;
    }
    .chat-input-row input[type="text"] {
      flex: 1 1 auto;
      padding: 1.2em 1em;
      font-size: 1em;
      font-family: 'Montserrat', sans-serif;
      border: 2px solid #e0e3ec;
      border-radius: 12px;
      background: #fff;
      outline: none;
      color: #23222e;
      transition: border 0.13s;
      box-shadow: 0 1px 10px #e0e8fd12;
    }
    .chat-input-row input[type="text"]:focus {
      border: 2px solid var(--rune);
    }
    .send-btn {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.15em;
      padding: 0 1.7em;
      border: none;
      border-radius: 12px;
      background: var(--blue-gradient);
      color: #fff;
      cursor: pointer;
      transition: background 0.17s, box-shadow 0.17s;
      box-shadow: var(--send-shadow);
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 100px;
      min-height: 48px;
      position: relative;
    }
    .send-btn:active, .send-btn:hover {
      background: linear-gradient(90deg, #345fa1 0%, #2b384b 100%);
      box-shadow: 0 4px 20px #40598533;
    }
    .send-btn svg {
      margin-right: 0.7em;
      width: 1.25em;
      height: 1.25em;
      fill: #fff;
    }
    .powered {
      text-align: center;
      font-size: 0.93em;
      color: #9c9aa2;
      margin: 14px auto 2px auto;
      font-family: 'Montserrat', sans-serif;
    }
    .powered a {
      background: #f4e7c1;
      color: #6a5734;
      font-weight: 700;
      border-radius: 7px;
      text-decoration: none;
      padding: 3px 10px 2px 10px;
      box-shadow: 0 1px 6px #d5c38528;
      margin-left: 8px;
      font-size: 1em;
      transition: background 0.18s;
    }
    .powered a:hover { background: #ece3b1; }
    /* Loader (Well of Wisdom) */
    .loader-bg {
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      z-index: 12;
      background: var(--bg-loader);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      animation: fadeIn 0.3s;
      transition: opacity 0.22s;
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    .well-loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .well-rune {
      font-family: 'EB Garamond', serif;
      font-size: 2.3em;
      color: var(--rune);
      animation: rune-spin 1.3s linear infinite;
      margin-bottom: 0.4em;
      text-shadow: 0 0 14px #4e6280a2;
      user-select: none;
    }
    @keyframes rune-spin {
      0% { transform: rotate(0deg) scale(1); opacity: 0.93;}
      60% { transform: rotate(360deg) scale(1.12); opacity: 1;}
      100% { transform: rotate(720deg) scale(1); opacity: 0.93;}
    }
    .well-msg {
      font-size: 1.07em;
      color: #4c4f63;
      font-family: 'Montserrat', sans-serif;
      margin-top: 0.7em;
      letter-spacing: 0.01em;
    }
    @media (max-width: 650px) {
      .chat-panel { max-width: 99vw; border-radius: 15px; padding-bottom: 0.3em;}
      .chat-card { min-height: 180px; max-height: 260px;}
      .ask-odin-header { font-size: 2em; }
      .odin-underline { width: 140px; }
      .runes-row { font-size: 1.07em; }
      .valhalla-logo { width: 64px; height: 64px; top: -32px; }
      .valhalla-logo img { width: 58px; height: 58px; }
      .chat-messages { font-size: 0.98em; padding: 0.6em 0.6em 0.3em 0.6em; }
      .msg-user { font-size: 0.97em; padding: 0.31em 0.8em;}
      .msg-odin { font-size: 0.97em; padding: 0.5em 0.7em 0.55em 0.7em;}
    }
    /* Subtle scrollbar styling */
    ::-webkit-scrollbar {
      width: 9px; background: #f4f6f9;
    }
    ::-webkit-scrollbar-thumb {
      background: #c7d0e8;
      border-radius: 6px;
    }
    /* Hide number arrows in Chrome for range input */
    input[type="range"]::-webkit-slider-thumb { appearance: none;}
    input[type="range"]::-moz-range-thumb { appearance: none;}
    input[type="range"]::-ms-thumb { appearance: none;}
    /* ARIA/accessibility improvements */
    .send-btn[aria-disabled="true"] { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>
<div class="valhalla-wrapper">
  <div class="chat-panel">
    <!-- LOGO -->
    <div class="valhalla-logo" aria-label="Odin's gold logo">
      <img src="https://cdn.shopify.com/s/files/1/0620/9958/7203/files/55cc97d6-4989-41cc-aa0c-67b94a56f29f.png?v=1751060831" alt="Odin gold logo" />
    </div>
    <!-- RUNES ROW -->
    <div class="runes-row">ᚠ ᚱ ᚾ ᚨ  ᚠ ᛁ ᚺ ᛃ ᚱ ᛗ ᚾ ᛗ</div>
    <!-- MUSIC CONTROLS -->
    <div class="music-controls">
      <button class="music-btn" id="music-play" aria-label="Toggle meditation music">
        <span id="music-note">♫</span>
      </button>
      <input type="range" id="music-vol" class="music-slider" min="0" max="1" step="0.01" value="0.33" aria-label="Music volume">
    </div>
    <!-- HEADER -->
    <div class="ask-odin-header">
      ASK&nbsp;
      <span class="odin-o" tabindex="0" aria-label="Odin rune O"
            onmouseover="this.querySelector('.letter').style.opacity=0;this.querySelector('.rune').style.display='inline';"
            onmouseout="this.querySelector('.letter').style.opacity=1;this.querySelector('.rune').style.display='none';">
        <span class="letter">O</span>
        <span class="rune" style="display:none;">ᛟ</span>
      </span>
      DIN
    </div>
    <!-- Underline Arrow -->
    <div class="odin-underline">
      <svg viewBox="0 0 210 18" fill="none">
        <line x1="6" y1="10" x2="204" y2="10" stroke="#b8a25a" stroke-width="4" stroke-linecap="round"/>
        <polygon points="204,10 192,4 192,16" fill="#b8a25a"/>
      </svg>
    </div>
    <div class="odin-desc">Wisdom, legacy, and Norse myth for the modern world</div>
    <!-- CHAT CARD -->
    <div class="chat-card">
      <div id="odin-loader" class="loader-bg" style="display:none;">
        <div class="well-loader">
          <div class="well-rune" id="loader-rune">ᚠ</div>
          <div class="well-msg">Odin is accessing the Well of Wisdom...</div>
        </div>
      </div>
      <div id="chat-messages" class="chat-messages" role="log" aria-live="polite"></div>
    </div>
    <!-- CHAT INPUT -->
    <div class="chat-input-row">
      <input type="text" id="user-input" placeholder="Ask your question..." autocomplete="off" aria-label="Ask Odin" />
      <button id="send-btn" class="send-btn" aria-label="Send message">
        <svg width="22" height="22" viewBox="0 0 18 18"><path d="M3.1 16.2l13.2-7.5c.5-.3.5-1 0-1.3L3.1.9C2.6.6 2 .9 2 1.5v15c0 .6.6.9 1.1.7z"/></svg>
        SEND
      </button>
    </div>
    <div class="powered">
      Powered by <a href="https://valhallasedge.com" target="_blank">Valhalla’s Edge</a>
    </div>
  </div>
</div>
<!-- Meditation Audio (Royalty-free) -->
<audio id="odin-music" loop src="https://cdn.pixabay.com/audio/2023/03/29/audio_12b5227dc7.mp3"></audio>
<script>
  // Runes for loader spinning
  const runes = ['ᚠ', 'ᚱ', 'ᚾ', 'ᚨ', 'ᚠ', 'ᛁ', 'ᚺ', 'ᛃ', 'ᚱ', 'ᛗ', 'ᚾ', 'ᛗ', 'ᛟ', 'ᛉ'];
  let runeIndex = 0, loaderInterval = null;

  // Loader control
  function showLoader(on=true) {
    const loader = document.getElementById('odin-loader');
    if (on) {
      loader.style.display = 'flex';
      // Animate runes
      clearInterval(loaderInterval);
      loaderInterval = setInterval(()=>{
        document.getElementById('loader-rune').textContent = runes[runeIndex % runes.length];
        runeIndex++;
      }, 350);
    } else {
      loader.style.display = 'none';
      clearInterval(loaderInterval);
    }
  }

  // Odin music player
  const music = document.getElementById('odin-music');
  const playBtn = document.getElementById('music-play');
  const note = document.getElementById('music-note');
  const vol = document.getElementById('music-vol');
  let isPlaying = false;
  function setMusicIcon() {
    note.textContent = isPlaying ? "🎵" : "♫";
    playBtn.classList.toggle('playing', isPlaying);
  }
  playBtn.onclick = function() {
    if (isPlaying) {
      music.pause(); isPlaying=false; setMusicIcon();
    } else {
      music.volume = vol.value;
      music.play().then(()=>{isPlaying=true;setMusicIcon();}).catch(()=>{});
    }
  }
  vol.oninput = function() {
    music.volume = this.value;
  }
  music.onended = music.onpause = ()=>{ isPlaying=false; setMusicIcon(); }
  music.onplay = ()=>{ isPlaying=true; setMusicIcon(); }
  // Keyboard: ESC = stop music
  document.addEventListener('keydown', e=>{
    if(e.key==="Escape"){ music.pause(); }
    if(e.key==="Enter" && document.activeElement.id === "user-input") { sendMessage(); }
  });

  // Chat logic
  const chat = document.getElementById('chat-messages');
  const input = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  let sending = false;

  function formatOdinMsg(txt) {
    // Bold THE MYTH, THE MESSAGE, etc.
    txt = txt.replace(/(THE MYTH|THE MESSAGE|THE MOVE|LEGACY ECHO|THE LEGACY|THE TEACHING|THE CHALLENGE)/g,
      '<strong>$1</strong>');
    // Pop wisdom, echoes, focus
    txt = txt.replace(/\b(wisdom|focus|echoes?)\b/gi, '<span class="odin-pop">$1</span>');
    // Italicize inline with _
    txt = txt.replace(/_([^_]+)_/g, '<em>$1</em>');
    // Markdown bold
    txt = txt.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
    // Markdown italics
    txt = txt.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
    return txt;
  }

  async function sendMessage() {
    const userText = input.value.trim();
    if (!userText || sending) return;
    sending = true; sendBtn.setAttribute('aria-disabled','true');
    // Show user message
    chat.innerHTML += `<div class="msg-block"><span class="msg-user">You: ${userText}</span></div>`;
    chat.scrollTop = chat.scrollHeight;
    input.value = "";
    showLoader(true);
    // Always start new thread (no memory)
    let threadId = null;
    try {
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: userText, threadId })
      });
      const data = await resp.json();
      showLoader(false);
      let reply = data.reply || "Odin is silent.";
      chat.innerHTML += `<div class="msg-block"><div class="msg-odin">${formatOdinMsg(reply)}</div></div>`;
      chat.scrollTop = chat.scrollHeight;
    } catch(err) {
      showLoader(false);
      chat.innerHTML += `<div class="msg-block"><div class="msg-odin">Odin: (NETWORK ERROR: ${err.message})</div></div>`;
    }
    sending = false; sendBtn.removeAttribute('aria-disabled');
  }
  sendBtn.onclick = sendMessage;
  input.onkeydown = e=>{ if(e.key==="Enter") sendMessage(); };
  // Click input on page load (mobile friendly)
  setTimeout(()=>{ input.blur(); }, 500);

  // Accessibility focus (for screen readers)
  sendBtn.onfocus = ()=>{ sendBtn.setAttribute('aria-label','Send message to Odin'); }
  // Odin O hover for keyboard users
  document.querySelector('.odin-o').onfocus = function(){
    this.querySelector('.letter').style.opacity=0;
    this.querySelector('.rune').style.display='inline';
  };
  document.querySelector('.odin-o').onblur = function(){
    this.querySelector('.letter').style.opacity=1;
    this.querySelector('.rune').style.display='none';
  };
</script>
</body>
</html>
