<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Valhalla Pantheon â€“ Valhalla Coach</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{
    --brand:#ffe18d;                 /* selected god accent */
    --ink:#f8e6c3;
    --ring:#2a2a2a;
    --soft: rgba(255,225,141,.14);

    --card-w: min(96vw, 880px);
    --card-pad: 26px 18px 14px;
    --reply-min-h: clamp(100px, 16vh, 160px);
  }

  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background: transparent; /* let Shopify page show through */
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding: max(env(safe-area-inset-top), 0) 0 max(env(safe-area-inset-bottom), 12px);
  }

  /* ======= FULL-WIDTH CAROUSEL BAR ======= */
  .pantheon-bar{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.2));
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid #26231a;
  }
  .rail{
    height: 106px;
    display:flex; align-items:center; gap:18px;
    overflow-x:auto; overflow-y:hidden;
    overscroll-behavior-x: contain;
    -webkit-overflow-scrolling: touch;
    padding: 10px 18px;
    scroll-snap-type:x proximity;
    /* soft edge fade only at the very ends */
    mask-image: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent 100%);
    -webkit-mask-image: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent 100%);
  }
  .rail::-webkit-scrollbar{ height:10px }
  .rail::-webkit-scrollbar-thumb{ background:#3b3422; border-radius:100px }

  .chip{
    --hover:#ffe18d;                 /* set inline per-god */
    flex: 0 0 auto;
    width:92px; height:92px;
    border-radius:999px;
    border:3px solid var(--ring);
    background:#000;
    overflow:hidden;
    cursor:pointer;
    scroll-snap-align:center;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease, opacity .18s ease;
    /* tapered oval feel â€“ JS sets vars below */
    transform: perspective(900px) rotateY(var(--rotY,0deg)) translateY(var(--dy,0px)) scale(var(--sc,1));
    opacity: var(--op,1);
  }
  .chip img{
    width:100%; height:100%; object-fit:cover; object-position: top center;
    border-radius:inherit; display:block;
  }
  .chip:hover{
    border-color:var(--hover);
    box-shadow:0 0 18px 2px color-mix(in srgb, var(--hover) 55%, transparent);
    filter: saturate(1.08);
  }
  .chip[data-selected="true"]{
    transform: perspective(900px) rotateY(var(--rotY,0deg)) translateY(var(--dy,0px)) scale(calc(var(--sc,1) + .08));
    border-color:var(--brand);
    box-shadow:0 0 22px 3px color-mix(in srgb, var(--brand) 65%, transparent), inset 0 0 0 3px rgba(0,0,0,.45);
  }

  /* ======= CARD ======= */
  .card{
    position:relative;
    width: var(--card-w);
    margin: 14px auto 20px;
    padding: var(--card-pad);
    border-radius:24px;
    border:2px solid var(--brand);
    background: linear-gradient(180deg, rgba(18,18,18,.82), rgba(16,16,16,.76));
    box-shadow: 0 16px 70px rgba(0,0,0,.55), 0 0 40px 2px rgba(255,225,141,.05);
    z-index:10; /* always above the sticky rail */
  }

  #god-logo{
    width:132px; height:132px; border-radius:50%;
    object-fit:cover; object-position: top center;
    border:4px solid var(--brand);
    box-shadow: 0 0 20px 2px var(--soft), inset 0 0 18px rgba(0,0,0,.5);
    display:block; margin: 6px auto 8px;
  }
  #god-title{
    text-align:center; font-family:Montserrat,Inter,sans-serif; font-weight:700; letter-spacing:2px;
    font-size: clamp(1.35rem, 1.1rem + 1.2vw, 2.1rem);
    color: var(--brand);
    text-shadow: 0 2px 14px rgba(0,0,0,.35);
    margin: 0 0 4px;
  }
  #god-bio{
    text-align:center; color:#f3ebd7;
    margin: 0 10px 10px; font-size: clamp(.98rem, .92rem + .4vw, 1.12rem);
  }

  /* ======= RUIN TOKENS ======= */
  .tokens{
    display:flex; gap:10px; align-items:center; justify-content:center;
    margin: 8px 0 10px;
    font-weight:700; color:#ffefae;
  }
  /* crisp slow-flip rune (no fuzzy glow) */
  .rune-coin{
    width:26px; height:26px;
    display:grid; place-items:center;
    font-size:18px; font-weight:800; line-height:1;
    color:#ffe18d;
    -webkit-text-stroke: 1px #7a611f;  /* crisp edge */
            text-stroke: 1px #7a611f;  /* fallback ignored where unsupported */
    text-shadow: 0 0 6px rgba(255,225,141,.18); /* very subtle */
    transform-style: preserve-3d; backface-visibility: hidden;
    animation: slowFlip 6s linear infinite;
  }
  @keyframes slowFlip{ to{ transform: rotateY(1turn); } }

  /* ======= CHAT ======= */
  .history{
    position:relative;
    border:1px solid #29281e;
    border-radius:14px;
    padding: 12px 12px;
    min-height: var(--reply-min-h);
    max-height: clamp(220px, 42vh, 520px);
    overflow-y: auto;
    background: rgba(5,5,5,.30);
    -webkit-backdrop-filter: blur(2.5px);
    backdrop-filter: blur(2.5px);
    box-shadow: inset 0 0 0 1px rgba(255,225,141,.06), 0 6px 30px rgba(0,0,0,.25);
  }
  .history .msg{ margin: 8px 0; line-height:1.5 }
  .history .user{ color:#bfefff; text-align:right }
  .history .god{ color:var(--brand) }

  /* loader: fast flipping SINGLE rune (no coin), appears only while waiting */
  .loader{ display:flex; align-items:center; justify-content:center; height:32px; margin:8px 0 4px; }
  .rune-loader{
    width:30px; height:30px; display:grid; place-items:center;
    font-size:20px; font-weight:900; line-height:1;
    color:#ffe18d;
    -webkit-text-stroke: 1px #7a611f;
            text-stroke: 1px #7a611f;
    text-shadow: 0 0 6px rgba(255,225,141,.18);
    transform-style:preserve-3d; backface-visibility:hidden;
    animation: flipFast .8s linear infinite;
    user-select:none;
  }
  @keyframes flipFast{ to{ transform: rotateY(1turn); } }

  /* ======= INPUT ======= */
  .input-row{
    display:grid; grid-template-columns: 1fr auto; gap:10px;
    margin: 12px 0 6px;
  }
  .input-row input{
    background:#1d1d1d; border:1px solid #2b2b2b; color:#fff;
    border-radius:14px; font-size:1.02rem; padding:12px 14px; min-width:0;
  }
  .input-row button{
    background: var(--brand); color:#231f15; border:0; border-radius:14px;
    font-weight:800; padding: 12px 18px; cursor:pointer;
    font-family:Montserrat,Inter,sans-serif;
    box-shadow: 0 6px 18px rgba(255,225,141,.20);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .input-row button:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(255,225,141,.28) }

  /* ======= RESPONSIVE ======= */
  @media(max-width: 640px){
    .rail{ height: 96px; gap:14px; padding:8px 12px }
    .chip{ width:80px; height:80px; border-width:2.5px }
    .card{ width: min(96vw, 560px); margin-top: 12px; padding: 22px 14px 12px }
    #god-logo{ width:118px; height:118px }
    .input-row{ grid-template-columns: 1fr; }
    .input-row button{ width:100% }
  }
  @media(min-width: 1024px){
    .rail{ height: 116px }
    .chip{ width:96px; height:96px }
  }
</style>
</head>
<body>

<header class="pantheon-bar">
  <div id="rail" class="rail" aria-label="Choose your guide"></div>
</header>

<main class="card" id="card">
  <img id="god-logo" alt="Guide portrait" src="" />
  <div id="god-title"></div>
  <div id="god-bio"></div>

  <div class="tokens" aria-live="polite">
    <span id="ruinCoin" class="rune-coin" aria-hidden="true">áš±</span>
    <span>Ruin Tokens Remaining:&nbsp;<span id="ruin-tokens">10</span></span>
  </div>

  <section id="history" class="history" aria-live="polite"></section>

  <div id="loader" class="loader" hidden>
    <span id="runeLoader" class="rune-loader" aria-hidden="true">áš </span>
  </div>

  <form id="chat-form" class="input-row" autocomplete="off">
    <input id="chat-input" placeholder="Ask your guide anythingâ€¦" />
    <button type="submit" id="sendBtn">Send</button>
  </form>
</main>

<script>
/* ---------- Data ---------- */
const GODS = [
  { key:'odin', name:'Odin',     assistantId:'asst_D0BXH8CTZycU0ku9PjkUmW3T', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/mimir-icon.jpg?v=1752795592', color:'#1c64ff', bio:'Wisdom, vision, and strategyâ€”the Allfather.' },
  { key:'thor', name:'Thor',     assistantId:'asst_JNie4vDtknbropUsbuXF4OpG', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Thor_-God-of-Thunder_-Icon.jpg?v=1752622811', color:'#e14b3d', bio:'Strength, action, and resilienceâ€”the thunder god.' },
  { key:'loki', name:'Loki',     assistantId:'asst_hKdLlIlE66bKCjuuDzhwknFM', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Loki_-God-of-Mischief_-Icon.jpg?v=1752622811', color:'#0db18a', bio:'Creativity, wit, and transformationâ€”the trickster.' },
  { key:'freya',name:'Freya',    assistantId:'asst_A0oRwWmYijWwmRJuA2iO9JlR', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Freya_-Icon.jpg?v=1752622811',               color:'#c5277e', bio:'Healing, beauty, and abundanceâ€”the goddess of love.' },
  { key:'oz',   name:'Oz',       assistantId:'asst_Hk4WoxgaWQr5wbagpEtmQbuY', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Oz_-Icon.jpg?v=1752623378',                 color:'#ff9200', bio:'Transformation, wisdom, and masteryâ€”the digital wizard.' },
  { key:'tyr',  name:'Tyr',      assistantId:'asst_5RBZdhN1br4dkpDB6g1cRBCg', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/tyr---icon.jpg?v=1752803717',                 color:'#946140', bio:'Justice, discipline, and sacrificeâ€”the steadfast champion.' },
  { key:'heimdall', name:'Heimdall', assistantId:'asst_5BTp4L16s3LSFZWyOwHL2Qow', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/heimdall_-icon.jpg?v=1752622811',       color:'#8653eb', bio:'Clarity, vigilance, and protectionâ€”the ever-watchful guardian.' },
  { key:'skald',name:'Skald',    assistantId:'asst_mDsnxmXYWK6VVR2TGlWgr0Db', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Skald_-Icon.jpg?v=1752623003',               color:'#2b55e2', bio:'Story, poetry, and inspirationâ€”the bard of legend.' },
  { key:'coach',name:'Valhalla Coach', assistantId:'asst_0b7Qdwscxs168I4YFX2gKSUd', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Valhalla-Coach-Icon.jpg?v=1752623891',color:'#ffe18d', bio:'Motivation, discipline, and actionâ€”your ultimate Viking coach.' }
];

/* ---------- Elements ---------- */
const rail = document.getElementById('rail');
const card = document.getElementById('card');
const logo = document.getElementById('god-logo');
const titleEl = document.getElementById('god-title');
const bioEl = document.getElementById('god-bio');
const hist = document.getElementById('history');
const loader = document.getElementById('loader');
const runeLoader = document.getElementById('runeLoader');
const form = document.getElementById('chat-form');
const input = document.getElementById('chat-input');
const sendBtn = document.getElementById('sendBtn');

const ruinCoin = document.getElementById('ruinCoin');
const tokenEl = document.getElementById('ruin-tokens');

const params = new URLSearchParams(location.search);
const fromURL = (params.get('god')||'').toLowerCase();
let selected = GODS.find(g=>g.key.toLowerCase()===fromURL) || GODS.find(g=>g.key==='coach');
let chatHistory = [];

/* ---------- Helpers ---------- */
function setTheme(color){ document.documentElement.style.setProperty('--brand', color || '#ffe18d'); }
function hexToSoft(hex){ try{ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16); return `rgba(${r},${g},${b},0.38)`; }catch{ return 'rgba(255,225,141,.38)'; }}

/* ---------- Build rail ---------- */
const isDesktop = matchMedia('(hover: hover) and (pointer: fine)').matches;

function buildRail(){
  rail.innerHTML='';
  const list = isDesktop ? [...GODS, ...GODS] : [...GODS]; // â€œinfiniteâ€ feel on desktop only
  list.forEach(g=>{
    const chip = document.createElement('div');
    chip.className='chip';
    chip.title = g.name;
    chip.dataset.key = g.key;
    chip.dataset.selected = (g.key===selected.key);
    chip.style.setProperty('--hover', g.color);

    const img = document.createElement('img');
    img.alt = g.name; img.src = g.avatar; img.loading = 'lazy';
    chip.appendChild(img);

    chip.addEventListener('mouseenter', ()=> chip.style.boxShadow=`0 0 18px 2px ${hexToSoft(g.color)}`);
    chip.addEventListener('mouseleave', ()=> chip.style.boxShadow='none');
    chip.addEventListener('click', ()=> selectGod(g.key));
    rail.appendChild(chip);
  });
  centerOnSelected();
  applyTaper(); // initial
}

/* ---------- Taper/oval with minimal fade ---------- */
function applyTaper(){
  const center = rail.scrollLeft + rail.clientWidth/2;
  const maxDist = rail.clientWidth * .62; // influence range
  const edgeStart = 0.75;                 // only last ~25% starts to fade/tilt

  [...rail.children].forEach(ch=>{
    const mid = ch.offsetLeft + ch.clientWidth/2;
    const dist = Math.abs(mid - center);
    const t = Math.min(dist / maxDist, 1);         // 0 center .. 1 edge

    const scale = 1 - 0.10 * t;                     // <=10% smaller at far edge
    let opacity = 1; let tilt = 0; let dy = 0;

    if (t > edgeStart){
      const f = (t - edgeStart) / (1 - edgeStart);  // 0..1 only at the ends
      opacity = 1 - 0.30 * f;                       // gentle fade just at edges
      tilt = (mid < center ? -1 : 1) * (10 + 8*f);  // 10Â°â†’18Â°
      dy = 6 * f;                                   // slight dip
    }

    ch.style.setProperty('--sc', scale.toFixed(3));
    ch.style.setProperty('--op', opacity.toFixed(3));
    ch.style.setProperty('--rotY', tilt.toFixed(1)+'deg');
    ch.style.setProperty('--dy', dy.toFixed(1)+'px');
  });
}

/* ---------- Desktop auto-glide; Mobile = native scroll (no jitter) ---------- */
let rafId=null;
function startDesktopAuto(){
  if(!isDesktop) return;
  function tick(){
    rail.scrollLeft += 0.25; // slow, smooth
    if(rail.scrollLeft > rail.scrollWidth/2){ rail.scrollLeft = 0; } // seamless
    applyTaper();
    rafId = requestAnimationFrame(tick);
  }
  rafId = requestAnimationFrame(tick);
}
// Pause auto on interaction (desktop)
if(isDesktop){
  ['mouseenter','mousedown','focusin','touchstart'].forEach(ev=>{
    rail.addEventListener(ev, ()=> { if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }, {passive:true});
  });
  ['mouseleave','mouseup','blur','touchend'].forEach(ev=>{
    rail.addEventListener(ev, ()=> { if(!rafId) startDesktopAuto(); }, {passive:true});
  });
}
// Update taper on scroll (both)
let scrollTick=false;
rail.addEventListener('scroll', ()=>{
  if(!scrollTick){ scrollTick=true; requestAnimationFrame(()=>{ applyTaper(); scrollTick=false; }); }
},{passive:true});

function centerOnSelected(){
  const chip = [...rail.children].find(el=>el.dataset.key===selected.key);
  if(chip){
    rail.scrollLeft = chip.offsetLeft - (rail.clientWidth - chip.clientWidth)/2;
  }
}

/* ---------- Select & render ---------- */
function renderCard(){
  logo.src = selected.avatar;
  titleEl.textContent = selected.name;
  bioEl.textContent = selected.bio;
  setTheme(selected.color);
  input.placeholder = `Ask ${selected.name} anythingâ€¦`;
  [...rail.children].forEach(ch=> ch.dataset.selected = (ch.dataset.key===selected.key));
}
function renderHistory(){
  hist.innerHTML = chatHistory.map(m=>(
    `<div class="msg ${m.from==='user'?'user':'god'}">${marked.parse(m.text || '')}</div>`
  )).join('');
  hist.scrollTop = hist.scrollHeight;
}
function selectGod(key){
  const g = GODS.find(x=>x.key===key) || selected;
  selected = g;
  renderCard();
  chatHistory = [];
  renderHistory();
  getOrCreateThread(g.key);
}

/* ---------- Threads & chat ---------- */
function storageKey(g){ return `valhalla_thread_${g}`; }
async function getOrCreateThread(g){
  const k = storageKey(g);
  const existing = localStorage.getItem(k);
  if(existing && existing.startsWith('thread_')) return existing;
  try{
    const res = await fetch('https://odin-assistant-starter.vercel.app/api/start-thread', {method:'POST', headers:{'Content-Type':'application/json'}});
    const data = await res.json();
    if(data.threadId && data.threadId.startsWith('thread_')){ localStorage.setItem(k, data.threadId); return data.threadId; }
  }catch(e){ console.error(e); }
  return null;
}

/* ---------- Loader rune (fast flip + fast rune change) ---------- */
const RUNE_SET = ['áš ','áš¢','áš¦','áš¨','áš±','áš·','áš¹','ášº','áš¾','á›','á›ƒ','á›‡','á›‰'];
let runeTimer = null;
function showLoader(show){
  loader.hidden = !show;
  if(show){
    // fast rune shuffle while flipping
    let i = 0;
    runeLoader.textContent = RUNE_SET[i];
    if(runeTimer) clearInterval(runeTimer);
    runeTimer = setInterval(()=>{
      i = (i+1) % RUNE_SET.length;
      runeLoader.textContent = RUNE_SET[i];
    }, 160);
  }else{
    if(runeTimer){ clearInterval(runeTimer); runeTimer = null; }
  }
}

/* ---------- Form submit ---------- */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const t = (input.value||'').trim();
  if(!t) return;

  if(decrementToken() <= 0){ alert("ðŸ›‘ Youâ€™re out of Ruin Tokens. Come back tomorrow or earn more."); return; }

  chatHistory.push({from:'user', text:t});
  renderHistory();
  input.value='';

  showLoader(true);
  try{
    const threadId = await getOrCreateThread(selected.key);
    if(!threadId) throw new Error('no-thread');

    const res = await fetch('https://odin-assistant-starter.vercel.app/api/chat', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ assistantId: selected.assistantId, message: t, threadId })
    });
    const data = await res.json();
    showLoader(false);
    chatHistory.push({from:'god', text: data.reply || 'No reply from the gods.'});
    renderHistory();
  }catch(err){
    console.error(err);
    showLoader(false);
    chatHistory.push({from:'god', text:'âš ï¸ Network error. Please try again.'});
    renderHistory();
  }
});

/* ---------- Ruin tokens (daily) ---------- */
const DAILY_LIMIT=10, TOKEN_KEY="valhalla_tokens", DATE_KEY="valhalla_last_date";
function today(){ return new Date().toISOString().slice(0,10); }
function resetDaily(){ localStorage.setItem(TOKEN_KEY, DAILY_LIMIT); localStorage.setItem(DATE_KEY, today()); updateTokens(); }
function updateTokens(){ tokenEl.textContent = parseInt(localStorage.getItem(TOKEN_KEY)||'0'); }
function checkReset(){ const last = localStorage.getItem(DATE_KEY); if(last !== today()) resetDaily(); updateTokens(); }
function decrementToken(){ let t=parseInt(localStorage.getItem(TOKEN_KEY)||'0'); if(t>0){ t--; localStorage.setItem(TOKEN_KEY,t); } updateTokens(); return t; }

/* ---------- Slow-flip rune next to tokens cycles glyph softly ---------- */
let coinIdx = 4; // start áš±
ruinCoin.addEventListener('animationiteration', ()=>{
  coinIdx = (coinIdx + 1) % RUNE_SET.length;
  ruinCoin.textContent = RUNE_SET[coinIdx];
});

/* ---------- Init ---------- */
(function init(){
  buildRail();
  renderCard();
  renderHistory();
  checkReset();
  if(isDesktop) startDesktopAuto();
  setTimeout(()=> input.focus(), 150);
})();
</script>
</body>
</html>
