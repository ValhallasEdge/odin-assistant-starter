<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Valhalla Pantheon ‚Äì Valhalla Coach</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{
    --brand:#ffe18d;                 /* live theme accent (changes on select) */
    --bg: radial-gradient(1200px 600px at 50% -10%, #191919 0%, #0f0f0f 50%, #0b0b0b 100%);
    --panel:#141414;
    --panel2:#101010;
    --ink:#f8e6c3;
    --muted:#d7c8a0;
    --ring:#2a2a2a;
    --soft: rgba(255,225,141,.16);
  }

  /* Base page */
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg) fixed;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding: max(env(safe-area-inset-top), 0) 0 max(env(safe-area-inset-bottom), 12px);
  }

  /* Top carousel wrapper (full-width) */
  .pantheon-bar{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.28));
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid #26231a;
  }
  /* Carousel rail */
  .god-rail{
    --rail-h: 104px;
    height: var(--rail-h);
    display:flex;
    gap:16px;
    align-items:center;
    overflow-x:auto;
    overscroll-behavior-x:contain;
    scroll-snap-type:x mandatory;
    padding:10px 16px;
    mask-image: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent 100%);
    -webkit-mask-image: linear-gradient(90deg, transparent 0, #000 6%, #000 94%, transparent 100%);
  }
  .god-rail::-webkit-scrollbar{ height:10px }
  .god-rail::-webkit-scrollbar-thumb{ background:#3b3422; border-radius:100px }

  /* Avatar chip */
  .god-chip{
    position:relative;
    flex:0 0 auto;
    width:88px; height:88px;         /* desktop default */
    border-radius:999px;
    border:3px solid var(--ring);
    box-shadow: 0 0 0 0 var(--soft);
    overflow:hidden;
    cursor:pointer;
    scroll-snap-align:center;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
    background:#000;
  }
  .god-chip img{
    width:100%; height:100%;
    object-fit:cover; object-position:top center;
    border-radius:inherit; display:block;
  }
  .god-chip:hover{
    box-shadow: 0 0 18px 2px var(--soft);
    filter: saturate(1.08);
  }
  .god-chip[data-selected="true"]{
    transform: scale(1.09);
    border-color: var(--brand);
    box-shadow: 0 0 20px 2px var(--soft), inset 0 0 0 3px rgba(0,0,0,.45);
  }

  /* Depth/oval illusion (JS updates CSS vars) */
  .god-chip{
    transform: translateY(var(--dy,0px)) scale(var(--sc,1));
  }

  /* Card */
  .card{
    position:relative;
    max-width: 840px;
    width: min(96vw, 840px);
    margin: 18px auto 24px;
    border-radius:26px;
    background: linear-gradient(180deg, #161616, #121212);
    border: 2px solid var(--brand);
    box-shadow:
      0 16px 70px rgba(0,0,0,.55),
      0 0 40px 2px rgba(255,225,141,.05);
    padding: 26px 18px 14px;
  }

  /* Title & bio */
  #god-logo{
    width: 136px; height:136px; border-radius:50%;
    object-fit:cover; object-position: top center;
    border: 4px solid var(--brand);
    box-shadow: 0 0 24px 2px var(--soft), inset 0 0 18px rgba(0,0,0,.5);
    display:block; margin: 8px auto 10px;
  }
  #god-title{
    text-align:center;
    font-family:Montserrat,Inter,sans-serif; font-weight:700; letter-spacing:2px;
    font-size: clamp(1.3rem, 1.1rem + 1.2vw, 2.1rem);
    color: var(--brand);
    text-shadow: 0 2px 14px rgba(0,0,0,.35);
    margin: 2px 0 4px;
  }
  #god-bio{
    text-align:center;
    color:#f3ebd7;
    margin: 0 10px 6px;
    font-size: clamp(.98rem, .92rem + .4vw, 1.12rem);
  }

  /* Ruin tokens */
  .tokens{
    display:flex; gap:10px; align-items:center; justify-content:center;
    margin: 10px 0 12px;
    font-weight:700;
    color:#ffefae;
  }
  .coin{
    width:22px; height:22px; display:inline-block;
  }
  .coin svg{ display:block; width:100%; height:100%; }
  .coin .spin{ transform-origin:50% 50%; animation: spin 9s linear infinite; }
  @keyframes spin{ to{ transform: rotate(1turn); } }

  /* Chat history ‚Äì transparent, readable */
  .history{
    position:relative;
    border:1px solid #29281e;
    border-radius:14px;
    padding: 12px 12px;
    min-height: 140px;              /* ~ one inch on many mobiles */
    max-height: clamp(220px, 42vh, 520px);
    overflow-y:auto;
    background: rgba(5,5,5,.30);
    -webkit-backdrop-filter: blur(2.5px);
    backdrop-filter: blur(2.5px);
    box-shadow: inset 0 0 0 1px rgba(255,225,141,.06), 0 6px 30px rgba(0,0,0,.25);
  }
  .history .msg{ margin: 8px 0; line-height:1.5 }
  .history .user{ color:#bfefff; text-align:right }
  .history .god{ color:var(--brand) }

  .loader{
    text-align:center; user-select:none; letter-spacing:.25em;
    margin: 6px 0 2px; color: var(--brand); font-size: 1.3rem;
    animation: pulse .9s ease-in-out infinite alternate;
  }
  @keyframes pulse{ to{ opacity:.4; } }

  /* Input row ‚Äì always fits on mobile */
  .input-row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    margin: 14px 0 6px;
  }
  .input-row input{
    background:#1d1d1d; border:1px solid #2b2b2b; color:#fff;
    border-radius:14px; font-size:1.02rem; padding:12px 14px;
    min-width:0;
  }
  .input-row button{
    background: var(--brand); color:#231f15; border:0; border-radius:14px;
    font-weight:800; padding: 12px 18px; cursor:pointer;
    font-family:Montserrat,Inter,sans-serif;
    box-shadow: 0 6px 18px rgba(255,225,141,.20);
    transition: transform .12s ease, box-shadow .12s ease, color .12s ease, background .12s ease;
  }
  .input-row button:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(255,225,141,.28) }
  .input-row button:active{ transform: translateY(0) }

  /* Music row */
  .music{
    display:flex; align-items:center; gap:12px;
    background:#121212; border:1px solid #26231a; border-radius:12px;
    padding: 8px 10px; margin: 6px 0 2px;
  }
  .music button{
    background:none; border:0; font-size:1.45rem; cursor:pointer; color:var(--brand);
    transition: transform .14s ease, text-shadow .14s ease;
  }
  .music button.active, .music button:hover{
    text-shadow: 0 0 12px var(--soft); transform: scale(1.08) rotate(-6deg);
  }
  .music input[type="range"]{
    flex:1; accent-color: var(--brand);
  }

  /* Footer breathing room */
  .pad{ height:14px }

  /* Mobile tuning */
  @media(max-width: 640px){
    .god-rail{ --rail-h: 92px; gap:14px; padding: 8px 12px }
    .god-chip{ width:74px; height:74px; border-width:2.5px }
    .card{ width: min(96vw, 560px); padding: 22px 14px 12px; margin: 12px auto 18px }
    #god-logo{ width:120px; height:120px }
  }

  /* Desktop lux */
  @media(min-width: 1024px){
    .god-rail{ --rail-h: 116px }
    .god-chip{ width:96px; height:96px }
    .card{ border-width:2.5px }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    .god-rail{ scroll-behavior:auto }
    .coin .spin{ animation:none }
  }
</style>
</head>
<body>

<!-- Top rotating carousel -->
<header class="pantheon-bar">
  <div id="rail" class="god-rail" aria-label="Choose your guide">
    <!-- chips injected by JS -->
  </div>
</header>

<!-- Main Card -->
<main class="card" id="card">
  <img id="god-logo" alt="Guide portrait" src="" />
  <div id="god-title"></div>
  <div id="god-bio"></div>

  <div class="tokens" aria-live="polite">
    <span class="coin" aria-hidden="true">
      <!-- Gold coin with rune ·ö± -->
      <svg viewBox="0 0 64 64" role="img" aria-label="Ruin coin">
        <defs>
          <radialGradient id="g" cx="50%" cy="50%" r="60%">
            <stop offset="0%" stop-color="#fff6d1"/>
            <stop offset="45%" stop-color="#ffd86b"/>
            <stop offset="100%" stop-color="#b58623"/>
          </radialGradient>
        </defs>
        <circle cx="32" cy="32" r="28" fill="url(#g)" stroke="#8a651a" stroke-width="3"/>
        <g class="spin">
          <circle cx="32" cy="32" r="22" fill="none" stroke="#fff0b0" stroke-opacity=".5" stroke-width="2"/>
        </g>
        <text x="32" y="39" text-anchor="middle" font-size="24" font-family="serif" fill="#7a4c00">·ö±</text>
      </svg>
    </span>
    <span>Ruin Tokens Remaining:&nbsp;<span id="ruin-tokens">10</span></span>
  </div>

  <section id="history" class="history" aria-live="polite"></section>
  <div id="loader" class="loader" hidden>·ö® ·õü ·ö± ·õÉ ·ö∫ ·ö† ·öæ ·õè</div>

  <form id="chat-form" class="input-row" autocomplete="off">
    <input id="chat-input" class="chat-input" placeholder="Ask your guide anything‚Ä¶" />
    <button type="submit" id="sendBtn">Send</button>
  </form>

  <div class="music" id="music">
    <button id="musicPlay" aria-label="Play or pause music">üéµ</button>
    <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.25" />
  </div>

  <div class="pad"></div>
</main>

<audio id="bgAudio" preload="auto" loop></audio>

<script>
/* -----------------------------
   Data
------------------------------*/
const GODS = [
  { key:'odin', name:'Odin',     assistantId:'asst_D0BXH8CTZycU0ku9PjkUmW3T', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/mimir-icon.jpg?v=1752795592', color:'#1c64ff', music:'https://cdn.pixabay.com/audio/2022/12/19/audio_12b0e71fa2.mp3', bio:'Wisdom, vision, and strategy‚Äîthe Allfather.' },
  { key:'thor', name:'Thor',     assistantId:'asst_JNie4vDtknbropUsbuXF4OpG', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Thor_-God-of-Thunder_-Icon.jpg?v=1752622811', color:'#e14b3d', music:'https://cdn.pixabay.com/audio/2022/11/16/audio_125b5cfb62.mp3', bio:'Strength, action, and resilience‚Äîthe thunder god.' },
  { key:'loki', name:'Loki',     assistantId:'asst_hKdLlIlE66bKCjuuDzhwknFM', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Loki_-God-of-Mischief_-Icon.jpg?v=1752622811', color:'#0db18a', music:'https://cdn.pixabay.com/audio/2022/11/16/audio_125b5cfb62.mp3', bio:'Creativity, wit, and transformation‚Äîthe trickster.' },
  { key:'freya',name:'Freya',    assistantId:'asst_A0oRwWmYijWwmRJuA2iO9JlR', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Freya_-Icon.jpg?v=1752622811',               color:'#c5277e', music:'https://cdn.pixabay.com/audio/2022/10/16/audio_125b985df9.mp3', bio:'Healing, beauty, and abundance‚Äîthe goddess of love.' },
  { key:'oz',   name:'Oz',       assistantId:'asst_Hk4WoxgaWQr5wbagpEtmQbuY', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Oz_-Icon.jpg?v=1752623378',                 color:'#ff9200', music:'https://cdn.pixabay.com/audio/2022/07/26/audio_124b01b0b2.mp3', bio:'Transformation, wisdom, and mastery‚Äîthe digital wizard.' },
  { key:'tyr',  name:'Tyr',      assistantId:'asst_5RBZdhN1br4dkpDB6g1cRBCg', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/tyr---icon.jpg?v=1752803717',                 color:'#946140', music:'https://cdn.pixabay.com/audio/2023/03/27/audio_1285ba08f4.mp3', bio:'Justice, discipline, and sacrifice‚Äîthe steadfast champion.' },
  { key:'heimdall', name:'Heimdall', assistantId:'asst_5BTp4L16s3LSFZWyOwHL2Qow', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/heimdall_-icon.jpg?v=1752622811',       color:'#8653eb', music:'https://cdn.pixabay.com/audio/2022/12/19/audio_12b0e71fa2.mp3', bio:'Clarity, vigilance, and protection‚Äîthe ever-watchful guardian.' },
  { key:'skald',name:'Skald',    assistantId:'asst_mDsnxmXYWK6VVR2TGlWgr0Db', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Skald_-Icon.jpg?v=1752623003',               color:'#2b55e2', music:'https://cdn.pixabay.com/audio/2022/10/16/audio_125b985df9.mp3', bio:'Story, poetry, and inspiration‚Äîthe bard of legend.' },
  { key:'coach',name:'Valhalla Coach', assistantId:'asst_0b7Qdwscxs168I4YFX2gKSUd', avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Valhalla-Coach-Icon.jpg?v=1752623891',color:'#ffe18d', music:'https://cdn.pixabay.com/audio/2023/01/31/audio_12dbfc3fa1.mp3', bio:'Motivation, discipline, and action‚Äîyour ultimate Viking coach.' }
];

/* -----------------------------
   State / Elements
------------------------------*/
const qs = s=>document.querySelector(s);
const rail = qs('#rail');
const card = qs('#card');
const logo = qs('#god-logo');
const titleEl = qs('#god-title');
const bioEl = qs('#god-bio');
const hist = qs('#history');
const loader = qs('#loader');
const form = qs('#chat-form');
const input = qs('#chat-input');
const sendBtn = qs('#sendBtn');
const musicRow = qs('#music');
const musicBtn = qs('#musicPlay');
const musicVol = qs('#musicVol');
const audio = qs('#bgAudio');

const params = new URLSearchParams(location.search);
const fromURL = params.get('god');
let selected = GODS.find(g=>g.key===fromURL) || GODS.find(g=>g.key==='coach');

let chatHistory = [];

/* -----------------------------
   Theme & render
------------------------------*/
function setTheme(color){ document.documentElement.style.setProperty('--brand', color || '#ffe18d'); }

function renderRail(){
  rail.innerHTML='';
  // Duplicate items for infinite scroll loop
  const list = [...GODS, ...GODS];
  list.forEach((g, i)=>{
    const chip = document.createElement('div');
    chip.className='god-chip';
    chip.dataset.key = g.key;
    chip.dataset.selected = (g.key===selected.key);
    chip.title = g.name;
    chip.style.setProperty('--sc', g.key===selected.key ? 1.09 : 1);
    chip.innerHTML = `<img alt="${g.name}" src="${g.avatar}">`;
    chip.addEventListener('mouseenter', ()=>chip.style.boxShadow=`0 0 18px 2px ${hexToSoft(g.color)}`);
    chip.addEventListener('mouseleave', ()=>chip.style.boxShadow='0 0 0 0 var(--soft)');
    chip.addEventListener('click', ()=> selectGod(g.key));
    rail.appendChild(chip);
  });
  centerOnSelected();
}

function renderCard(){
  logo.src = selected.avatar;
  titleEl.textContent = selected.name;
  bioEl.textContent = selected.bio;
  setTheme(selected.color);
  input.placeholder = `Ask ${selected.name} anything‚Ä¶`;
  // music
  if(selected.music){
    musicRow.style.display='';
    audio.src = selected.music;
    audio.volume = parseFloat(musicVol.value||'0.25');
    audio.pause();
    musicBtn.classList.remove('active');
  }else{
    musicRow.style.display='none';
    audio.pause();
  }
}

function renderHistory(){
  hist.innerHTML = chatHistory.map(m=>(
    `<div class="msg ${m.from==='user'?'user':'god'}">${marked.parse(m.text || '')}</div>`
  )).join('');
  hist.scrollTop = hist.scrollHeight;
}

function selectGod(key){
  const g = GODS.find(x=>x.key===key) || selected;
  selected = g;
  [...rail.children].forEach(ch=>{
    ch.dataset.selected = (ch.dataset.key===g.key);
  });
  renderCard();
  chatHistory = [];
  renderHistory();
  persistThreadFor(g.key); // ensure thread
}

/* -----------------------------
   Infinite carousel (smooth)
------------------------------*/
let auto = { playing:true, speed: 0.25 }; // px per frame
let rafId = null;

function loop(){
  if(auto.playing){
    rail.scrollLeft += auto.speed;
    // loop seamlessly
    if(rail.scrollLeft > rail.scrollWidth/2){
      rail.scrollLeft = 0;
    }
  }
  applyDepth();
  rafId = requestAnimationFrame(loop);
}

function centerOnSelected(){
  // scroll to first instance of selected
  const chip = [...rail.children].find(el=>el.dataset.key===selected.key);
  if(chip){
    rail.scrollLeft = chip.offsetLeft - (rail.clientWidth - chip.clientWidth)/2;
  }
}

function applyDepth(){
  // Elliptical illusion: scale & vertical drift by distance to center
  const center = rail.scrollLeft + rail.clientWidth/2;
  [...rail.children].forEach(ch=>{
    const mid = ch.offsetLeft + ch.clientWidth/2;
    const dist = Math.abs(mid - center);
    const t = Math.min(dist / (rail.clientWidth * .6), 1); // 0 center .. 1 edge
    const sc = 1 - t*0.12;
    const dy = (Math.sin(t*Math.PI) * 10); // small dip
    ch.style.setProperty('--sc', sc.toFixed(3));
    ch.style.setProperty('--dy', dy.toFixed(1)+'px');
  });
}

// Pause on interaction
['mouseenter','mousedown','touchstart','focusin'].forEach(ev=>{
  rail.addEventListener(ev, ()=> { auto.playing = false; }, {passive:true});
});
['mouseleave','mouseup','touchend','blur'].forEach(ev=>{
  rail.addEventListener(ev, ()=> { auto.playing = true; }, {passive:true});
});

/* -----------------------------
   Threads & chat
------------------------------*/
function storageKeyFor(god){ return `valhalla_thread_${god}`; }

async function getOrCreateThread(godKey){
  const k = storageKeyFor(godKey);
  const existing = localStorage.getItem(k);
  if(existing && existing.startsWith('thread_')) return existing;

  try{
    const res = await fetch('https://odin-assistant-starter.vercel.app/api/start-thread',{method:'POST',headers:{'Content-Type':'application/json'}});
    const data = await res.json();
    if(data.threadId && data.threadId.startsWith('thread_')){
      localStorage.setItem(k, data.threadId);
      return data.threadId;
    }
  }catch(e){ console.error(e); }
  return null;
}
function persistThreadFor(godKey){ getOrCreateThread(godKey); }

function showLoader(show){
  loader.hidden = !show;
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const t = (input.value||'').trim();
  if(!t) return;

  if(decrementToken() <= 0){ alert("üõë You‚Äôre out of Ruin Tokens. Come back tomorrow or earn more."); return; }

  chatHistory.push({from:'user', text:t});
  renderHistory();
  input.value = '';
  showLoader(true);

  try{
    const threadId = await getOrCreateThread(selected.key);
    if(!threadId) throw new Error('thread');

    const res = await fetch('https://odin-assistant-starter.vercel.app/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ assistantId: selected.assistantId, message: t, threadId })
    });
    const data = await res.json();
    showLoader(false);
    chatHistory.push({from:'god', text: data.reply || 'No reply from the gods.'});
    renderHistory();
  }catch(err){
    console.error(err);
    showLoader(false);
    chatHistory.push({from:'god', text:'‚ö†Ô∏è Network error. Please try again.'});
    renderHistory();
  }
});

/* -----------------------------
   Music
------------------------------*/
let playing = false;
musicBtn.addEventListener('click', ()=>{
  if(!playing){ audio.muted=false; audio.play(); playing=true; musicBtn.classList.add('active'); }
  else { audio.pause(); playing=false; musicBtn.classList.remove('active'); }
});
musicVol.addEventListener('input', e=> audio.volume = parseFloat(e.target.value||'0.25') );

/* -----------------------------
   Ruin tokens (daily)
------------------------------*/
const DAILY_LIMIT=10, TOKEN_KEY="valhalla_tokens", DATE_KEY="valhalla_last_date";
const tokenEl = qs('#ruin-tokens');
function today(){ return new Date().toISOString().slice(0,10); }
function resetDaily(){
  localStorage.setItem(TOKEN_KEY, DAILY_LIMIT);
  localStorage.setItem(DATE_KEY, today());
  updateTokens();
}
function updateTokens(){
  tokenEl.textContent = parseInt(localStorage.getItem(TOKEN_KEY)||'0');
}
function checkReset(){
  const last = localStorage.getItem(DATE_KEY);
  if(last !== today()) resetDaily();
  updateTokens();
}
function decrementToken(){
  let t = parseInt(localStorage.getItem(TOKEN_KEY)||'0');
  if(t>0){ t--; localStorage.setItem(TOKEN_KEY,t); }
  updateTokens();
  return t;
}

/* -----------------------------
   Utils
------------------------------*/
function hexToSoft(hex){
  // convert #rrggbb to soft glow rgba string
  try{
    const c = hex.replace('#','');
    const r=parseInt(c.substring(0,2),16), g=parseInt(c.substring(2,4),16), b=parseInt(c.substring(4,6),16);
    return `rgba(${r},${g},${b},0.40)`;
  }catch(e){ return 'rgba(255,225,141,.38)'; }
}

/* -----------------------------
   Init
------------------------------*/
renderRail();
renderCard();
renderHistory();
checkReset();
centerOnSelected();
applyDepth();
loop(); // start carousel animation

// Keep the card centered visual stack (carousel never overlaps)
card.style.zIndex = 10;

// focus the input for quick typing
setTimeout(()=> input.focus(), 150);
</script>
</body>
</html>
