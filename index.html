<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ask Odin | Valhalla AI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Valhalla's Edge Odin AI: Norse wisdom and cinematic advice. Ask Odin your question." />
  <!-- Modern + Norse fonts -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-charcoal: #181b1e;
      --secondary-charcoal: #32343a;
      --heading-blue: #395885;
      --heading-burgundy: #87252c;
      --mist-bg: #f7f8fa;
      --faint-white: #fcfdff;
      --soft-gray: #dee2ea;
      --body-gray: #44464c;
      --rune-opacity: 0.08;
    }
    html, body {
      background: linear-gradient(132deg, var(--faint-white) 65%, #e9ebf2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', 'Georgia', serif;
      color: var(--primary-charcoal);
    }
    body::before {
      content: "";
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: url('https://www.transparenttextures.com/patterns/clouds.png'), linear-gradient(120deg, #eaecef 70%, #d3d8e2 100%);
      opacity: 0.12;
      filter: blur(1px);
      pointer-events: none;
      z-index: 0;
    }
    .chat-wrapper {
      max-width: 750px;
      margin: 70px auto 40px auto;
      background: rgba(255,255,255,0.96);
      border-radius: 2.3em;
      box-shadow: 0 12px 48px 0 #232b3718, 0 2px 22px #3b3f4540;
      padding: 2.4em 2em 2em 2em;
      border: 1.5px solid #eceef4;
      backdrop-filter: blur(4.5px) saturate(1.11);
      position: relative;
      z-index: 1;
    }
    .valhalla-header {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 0.6em;
    }
    .odin-logo {
      width: 72px;
      height: 72px;
      background: #16171b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 18px #181b1e20, 0 2px 6px #bfa76844;
      margin-bottom: 12px;
      border: 3.5px solid #d8bf78;
      z-index: 2;
      position: relative;
      overflow: hidden;
    }
    .odin-logo img {
      width: 94%;
      height: 94%;
      object-fit: contain;
      border-radius: 50%;
      display: block;
    }
    .runes-bg {
      position: absolute;
      top: 35px; left: 50%;
      transform: translateX(-50%);
      font-family: 'UnifrakturCook', serif;
      color: #2c2f34;
      font-size: 2.4em;
      letter-spacing: 0.45em;
      opacity: var(--rune-opacity);
      pointer-events: none;
      z-index: 1;
      user-select: none;
      white-space: nowrap;
    }
    .header-title {
      position: relative;
      z-index: 2;
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-size: 2.4em;
      font-weight: 700;
      letter-spacing: 1.1px;
      color: var(--primary-charcoal);
      margin: 0 0 0.19em 0;
      text-shadow: 0 1px 10px #d6d7dd44;
    }
    .norse-underline {
      width: 76px;
      height: 4px;
      margin: -12px auto 24px auto;
      background: linear-gradient(90deg, var(--secondary-charcoal), var(--mist-bg) 95%);
      border-radius: 2px;
      opacity: 0.22;
      box-shadow: 0 0 12px #a7bbce17;
    }
    /* Loader */
    #loader {
      display: none;
      text-align: center;
      margin: 1em 0 1.13em 0;
      color: var(--secondary-charcoal);
      font-style: italic;
      font-size: 1.07em;
      font-family: 'Montserrat', serif;
      transition: opacity 0.33s;
    }
    .loader-rune {
      display: inline-block;
      font-family: 'UnifrakturCook', serif;
      font-size: 2em;
      color: var(--heading-blue);
      margin-right: 10px;
      vertical-align: middle;
      filter: drop-shadow(0 0 8px #bfc5da55);
      animation: runespin 2.1s linear infinite;
    }
    @keyframes runespin {
      0% { transform: rotateY(0);}
      100% { transform: rotateY(360deg);}
    }
    .loader-dots::after {
      content: '';
      display: inline-block;
      width: 1em;
      text-align: left;
      animation: ellipsis steps(4,end) 1.13s infinite;
    }
    @keyframes ellipsis { to { width: 4em; } }
    /* CHAT */
    .chat-box {
      height: 420px;
      overflow-y: auto;
      border-radius: 1.4em;
      padding: 1.28em 1.88em 1.2em 1.15em;
      background: var(--mist-bg);
      margin-bottom: 1.5em;
      box-shadow: 0 0 12px #c9ccd411;
      border: 1.2px solid #eceef4;
      position: relative;
      font-size: 1.07em;
      scroll-behavior: smooth;
      transition: box-shadow 0.38s;
    }
    .msg { opacity: 0; animation: fadeIn 0.48s forwards; margin-bottom: 1.13em; line-height: 1.66;}
    @keyframes fadeIn { from { opacity: 0;} to { opacity: 1;}}
    .msg.user {
      color: var(--primary-charcoal);
      background: linear-gradient(97deg, #f7f7f7 80%, #e3e7ee 100%);
      border-radius: 10px 21px 16px 10px;
      padding: 0.8em 1.25em 0.95em 1.2em;
      font-weight: 700;
      margin: 0.75em 0 0.7em 40%;
      border-left: 2.2px solid var(--heading-blue);
      box-shadow: 1px 2px 10px #bfc5da11;
      word-break: break-word;
    }
    .msg.odin {
      color: var(--body-gray);
      background: linear-gradient(100deg, #fcfcfe 95%, #e9ebf2 100%);
      border-left: 4px solid var(--heading-blue);
      padding: 1.18em 1.28em 1.05em 1.32em;
      margin: 0.7em 28% 0.7em 0;
      border-radius: 18px 11px 11px 24px;
      box-shadow: 2px 4px 18px #bfc5da1a;
      word-break: break-word;
      font-size: 1.13em;
      font-family: 'Montserrat', serif;
      position: relative;
      overflow: visible;
      transition: box-shadow 0.5s;
    }
    /* Odin headings (pop color every so often) */
    .msg.odin h1, .msg.odin h2, .msg.odin h3, .msg.odin h4, .msg.odin h5, .msg.odin h6, .msg.odin strong.section-title {
      font-family: 'Montserrat', serif;
      font-weight: 700;
      letter-spacing: 0.2px;
      margin: 0.9em 0 0.5em 0;
      line-height: 1.22;
      color: var(--secondary-charcoal);
      text-shadow: 0 0 6px #d2d5db11;
    }
    /* Pop color for headings that have certain words */
    .msg.odin h1, .msg.odin h2, .msg.odin h3 {
      color: var(--heading-blue);
    }
    .msg.odin h1.section-burgundy, .msg.odin h2.section-burgundy, .msg.odin h3.section-burgundy {
      color: var(--heading-burgundy) !important;
    }
    .msg.odin h4, .msg.odin h5, .msg.odin h6 { color: var(--secondary-charcoal);}
    .msg.odin ul, .msg.odin ol { margin: 0.82em 0 0.82em 2em;}
    .msg.odin strong { color: var(--primary-charcoal); font-weight: 700;}
    .msg.odin em { color: var(--heading-burgundy); font-style: italic;}
    .msg.odin code {
      font-family: monospace; background: #ededf5; padding: 2px 6px; border-radius: 4px; color: var(--heading-blue); font-size: 1em;
    }
    .msg.odin hr { border: none; border-top: 1.2px solid #bfc5da44; margin: 1em 0;}
    .msg.odin a { color: var(--heading-blue); text-decoration: underline dotted;}
    .msg.odin a:hover { color: var(--heading-burgundy);}
    /* Subtle fog effect (desktop only, Odin reply) */
    .msg.odin:hover::before {
      content: '';
      pointer-events: none;
      position: absolute;
      left: -7%; right: -7%; top: -11%; bottom: -10%;
      z-index: 2;
      background: radial-gradient(circle at 56% 60%, #bfc5da23 42%, #f7fafb0a 92%);
      opacity: 0.56;
      animation: fog-move 2.2s linear infinite alternate;
      filter: blur(9px) brightness(1.08);
    }
    @keyframes fog-move {
      from { background-position: 52% 56%;}
      to   { background-position: 48% 44%;}
    }
    .input-area {
      display: flex;
      gap: 1em;
      margin-top: 1.1em;
      align-items: center;
    }
    .input-area input {
      flex: 1;
      padding: 1.15em;
      font-size: 1.13em;
      border: 2.1px solid #bfc5da;
      border-radius: 14px;
      background: #f6f8fa;
      outline: none;
      transition: border 0.23s, box-shadow 0.3s;
      color: var(--secondary-charcoal);
      font-weight: 400;
    }
    .input-area input:focus {
      border: 2.8px solid var(--heading-blue);
      box-shadow: 0 0 7px #adadc7;
    }
    .input-area button {
      padding: 1.08em 2.18em;
      font-size: 1.14em;
      background: linear-gradient(to right, var(--secondary-charcoal), #bfc5da);
      color: #fff;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 1.5px 10px #bfc5da19;
      letter-spacing: 0.09em;
      transition: background 0.3s, box-shadow 0.3s;
      font-family: inherit;
    }
    .input-area button:hover {
      background: linear-gradient(to right, #363b47, #e5e6e8 100%);
      box-shadow: 0 6px 16px #adadc7a1;
      color: var(--primary-charcoal);
    }
    @media (max-width: 700px) {
      .chat-wrapper { padding: 0.6em 0.5vw;}
      .chat-box { height: 240px;}
      .header-title { font-size: 1.32em;}
      .norse-underline { width: 43px;}
      .runes-bg { font-size: 1.18em; top: 13px;}
      .input-area input, .input-area button { font-size: 0.98em; padding: 1em;}
      .odin-logo { width: 44px; height: 44px;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="chat-wrapper">
    <div class="valhalla-header">
      <span class="odin-logo">
        <!-- Swap the src to your actual logo URL -->
        <img src="https://valhallasedge.com/cdn/shop/files/Odin_logo_gold.png" alt="Odin Medallion" loading="lazy" />
      </span>
      <div class="runes-bg">ᚨᚱᚢᛟ ᚨᛁ</div>
      <span class="header-title">Ask Odin</span>
    </div>
    <div class="norse-underline"></div>
    <div id="chat" class="chat-box" aria-live="polite"></div>
    <div id="loader">
      <span class="loader-rune">ᚨ</span>
      Odin is searching the Well of Wisdom<span class="loader-dots">...</span>
    </div>
    <div class="input-area">
      <input id="user-input" type="text" placeholder="Ask your question..." onkeydown="if(event.key==='Enter'){sendMessage()}" autocomplete="off" aria-label="Ask your question to Odin" />
      <button onclick="sendMessage()" aria-label="Send message to Odin">SEND</button>
    </div>
  </div>
<script>
  async function sendMessage() {
    const input = document.getElementById('user-input');
    const chat = document.getElementById('chat');
    const loader = document.getElementById('loader');
    const userText = input.value.trim();
    if (!userText) return;

    // Always use a new thread (no memory)
    let threadId = null;
    localStorage.removeItem('odinThreadId'); // just in case

    chat.innerHTML += `<div class="msg user">You: ${escapeHTML(userText)}</div>`;
    input.value = '';
    chat.scrollTop = chat.scrollHeight;

    // Show loader
    loader.style.display = 'block';

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userText, threadId })
      });

      const data = await response.json();

      loader.style.display = 'none';

      if (data.reply) {
        // Color some headings (H1/H2/H3) with blue or burgundy based on their content
        let html = marked.parse(data.reply);
        html = html.replace(/(<h[1-3]>)(.*Z.*?)(<\/h[1-3]>)/gi, function(_, open, mid, close) {
          return open.replace(">", ' class="section-burgundy">') + mid + close;
        });
        chat.innerHTML += `<div class="msg odin">${html}</div>`;
      } else if (data.error) {
        chat.innerHTML += `<div class="msg odin">Odin: ERROR - ${escapeHTML(data.error)}</div>`;
      } else {
        chat.innerHTML += `<div class="msg odin">Odin: (No response from Valhalla...)</div>`;
      }
    } catch
