<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Markdown (kept) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <meta charset="utf-8"/>
  <title>Valhalla Pantheon – Valhalla Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400|Inter:400,700&display=swap" rel="stylesheet"/>

  <style>
  /* ================== THEME & SIZING ================== */
  :root{
    --default-color:#ffe18d;
    --bg: linear-gradient(135deg,#141414 0%,#232323 100%);
    --font-main:'Montserrat','Inter',sans-serif;

    /* Desktop: ~20% bigger overall */
    --card-w: clamp(560px, 78vw, 980px);
    --card-pad: 36px 28px 20px 28px;
    --title-size: clamp(1.9rem, 2.6vw, 3.2rem);
    --bio-size: clamp(1.05rem, 1.25vw, 1.22rem);
    --chat-size: clamp(1rem, 1.15vw, 1.14rem);

    --avatar-w: 88px;   /* bigger faces */
    --avatar-h: 88px;
    --avatar-img: 76px;

    --rail-bg: rgba(25,25,25,.92);
  }
  @media (max-width: 640px){
    :root{
      --card-w: 96vw;
      --card-pad: 26px 16px 18px 16px;
      --title-size: clamp(1.5rem, 5vw, 1.9rem);
      --avatar-w: 84px;
      --avatar-h: 84px;
      --avatar-img: 72px;
    }
  }

  /* ================== PAGE ================== */
  body{
    background: var(--bg);
    min-height:100vh;
    margin:0; padding:0 0 48px 0;
    font-family: var(--font-main);
    color:#f8e6c3;
    display:flex; flex-direction:column; align-items:center;
  }

  /* ================== STICKY AVATAR RAIL ================== */
  .god-rail-wrap{
    position:sticky; top:0; z-index:6;
    width:100%;
    background: var(--rail-bg);
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 14px #0007;
    display:flex; justify-content:center;
  }
  .god-selector-bar{
    display:flex; gap:18px; align-items:center;
    width:min(98vw, var(--card-w));
    padding:10px 10px 12px 10px;
    overflow-x:auto; overflow-y:hidden;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x proximity;
    border-radius: 0 0 18px 18px;
  }
  .god-selector-bar::-webkit-scrollbar{ height:8px; }
  .god-selector-bar::-webkit-scrollbar-thumb{ background:#2b2b2b; border-radius:8px; }

  .god-avatar{
    flex:0 0 auto;
    width:var(--avatar-w); height:var(--avatar-h);
    border:3px solid #333; border-radius:100px;
    background:#000; cursor:pointer; user-select:none;
    display:flex; align-items:center; justify-content:center;
    transition: border-color .18s, box-shadow .18s, transform .16s;
    scroll-snap-align:center;
    outline:none;
    position:relative;
  }
  .god-avatar:hover{
    /* faint glow picks up current --default-color */
    box-shadow: 0 0 16px 2px color-mix(in srgb, var(--default-color) 42%, transparent);
    border-color: var(--default-color);
  }
  .god-avatar.selected{
    border-color: var(--default-color) !important;
    box-shadow: 0 0 18px 2px color-mix(in srgb, var(--default-color) 60%, transparent);
    transform: scale(1.06);
  }
  .god-avatar:focus{
    outline:2px solid var(--default-color);
    outline-offset:2px;
  }
  .god-avatar img{
    width:var(--avatar-img); height:var(--avatar-img);
    object-fit:cover; object-position:top center;
    border-radius:50%; background:#181818; display:block;
  }

  /* ================== CARD ================== */
  .valhalla-card{
    background:
      radial-gradient(1100px 620px at 50% -10%, rgba(255,255,255,.05), transparent 60%),
      rgba(25,25,25,.97);
    border: 2.5px solid var(--default-color);
    border-radius:32px;
    box-shadow:
      0 18px 80px color-mix(in srgb, var(--default-color) 18%, #000),
      inset 0 0 80px rgba(255,255,255,.03);
    width:min(98vw, var(--card-w));
    margin: 44px auto 0 auto;
    padding: var(--card-pad);

    /* IMPORTANT: let content set height so the PAGE scrolls, not inner elements */
    min-height: 0;
    display:flex; flex-direction:column; align-items:center;
    position:relative; isolation:isolate;
    animation: fadeIn .8s ease;
  }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(18px);} to{opacity:1; transform:translateY(0);} }

  #god-logo{
    width:136px; height:136px;
    border-radius:50%;
    object-fit:cover; object-position:top center;
    border:3px solid var(--default-color);
    margin: 22px 0 10px 0;
    box-shadow: 0 0 14px 2px color-mix(in srgb, var(--default-color) 38%, transparent);
  }
  .god-title{
    font-size:var(--title-size);
    letter-spacing:2px; font-weight:700; text-align:center;
    color:var(--default-color);
    margin:10px 0 6px;
    text-shadow:0 2px 16px #0002;
  }
  .god-bio{
    font-size:var(--bio-size);
    color:#f3ebd7; text-align:center;
    margin:0 0 10px 0;
  }

  /* ================== RUIN TOKENS ================== */
  .ruin-row{
    display:flex; align-items:center; gap:10px;
    font-weight:bold; color:#FFD700; margin: 6px 0 12px 0;
  }
  .rune-coin{
    width:26px; height:26px; border-radius:50%;
    display:inline-grid; place-items:center;
    border:2px solid #FFD700;
    background: radial-gradient(circle at 30% 30%, #fff2a8 0%, #ffd76c 36%, #b88a2a 70%, #926f22 100%);
    box-shadow: 0 0 10px #ffd76c44, inset 0 0 4px #0008;
    animation: runeSpin 6s linear infinite;
    font-size: 16px; color:#4e3b00; /* rune color */
    font-family: "Inter", sans-serif;
    user-select:none;
  }
  .rune-coin::before{ content: "ᚠ"; } /* Fehu = wealth */
  @keyframes runeSpin{ to{ transform: rotate(1turn); } }
  .rune-coin:hover{
    box-shadow: 0 0 14px #ffd76c88, inset 0 0 6px #0009;
    transform: scale(1.04);
  }

  /* ================== CHAT ================== */
  .chat-history{
    width:100%;
    /* Let it expand naturally so the IFRAME/page controls scrolling */
    overflow: visible;
    background: rgba(16,16,16,.88);
    border:1.5px solid #29281e;
    border-radius:17px;
    padding:14px 13px;
    font-size:var(--chat-size);
    margin-bottom:12px;
    box-shadow: 0 2px 14px #0002, 0 4px 28px 2px color-mix(in srgb, var(--default-color) 18%, transparent);
  }
  .chat-msg{ margin-bottom:10px; padding:.25em 0; }
  .chat-msg.user{ text-align:right; color:#c8f7ff; }
  .chat-msg.god{ text-align:left; color:var(--default-color); }
  .chat-msg.god strong{ color:var(--default-color); }
  .chat-msg.god em{ color:#ffdea0; font-style:italic; }
  .chat-msg.god ul{ margin:8px 0 8px 22px; padding-left:0; }
  .chat-msg.god li{ margin-bottom:4px; }

  .loader-runic{
    margin: 4px auto .2em auto;
    font-size:1.85em; letter-spacing:.19em;
    color:var(--default-color);
    animation: spinRunes 1.3s linear infinite;
    text-align:center; user-select:none;
  }
  @keyframes spinRunes{ 100%{ transform: rotate(1turn); } }

  .chat-input-row{
    display:flex; width:100%;
    gap:10px; margin-top:18px;
    align-items:center;
  }
  .chat-input{
    flex:1; padding:12px 16px;
    border-radius:22px; border:none; outline:none;
    background:#222; color:#fff9ec; font-size:1.08rem;
    font-family:'Inter',sans-serif;
    box-shadow: 0 1px 8px #0004;
  }
  .chat-send-btn{
    background:var(--default-color); color:#232323;
    border:none; border-radius:24px;
    padding:10px 20px; font-size:1.04rem;
    font-family:'Montserrat',sans-serif; font-weight:700;
    cursor:pointer;
    transition: background .16s, color .12s, transform .12s;
    box-shadow: 0 1px 8px #0003;
  }
  .chat-send-btn:hover{ background:#fff6dc; color:var(--default-color); transform: translateY(-1px); }

  /* ================== MUSIC ================== */
  .music-player-row{
    width:100%; display:flex; align-items:center; justify-content:center;
    gap:12px; background:#181818; border:1px solid #2a2a2a;
    border-radius:13px; padding:8px 10px; margin:12px auto 0 auto;
  }
  .music-play-btn{
    background:none; border:none; cursor:pointer;
    font-size:1.62em; color:var(--default-color);
    transition: color .16s, transform .13s;
  }
  .music-play-btn.active, .music-play-btn:hover{
    box-shadow: 0 0 8px var(--default-color);
    color:#fff6dc; transform: scale(1.12) rotate(-7deg);
  }
  .music-slider{ accent-color:var(--default-color); margin-left:3px; }
  .music-slider::-webkit-slider-thumb{
    background:#ffe18d; border:none; height:14px; width:14px; border-radius:50%;
    cursor:pointer; margin-top:-4px;
  }
  .music-slider::-webkit-slider-runnable-track{ background:#444; height:6px; border-radius:3px; }

  /* ================== BUY TOKENS ================== */
  .buy-btn{
    margin: 14px auto 0 auto;
    background:#1a1a1a; color:#FFD700;
    padding:10px 16px; border:2px solid #FFD700;
    border-radius:10px; font-weight:bold; display:block;
    cursor:pointer;
  }
  .buy-btn:hover{ filter: brightness(1.06); }

  /* ================== MOBILE POLISH ================== */
  @media (max-width: 640px){
    .valhalla-card{ margin-top: 24px; }
    .god-selector-bar{ padding: 10px 8px 12px 8px; }
    .music-player-row{ font-size:1rem; }
  }
  </style>
</head>

<body>
  <!-- Sticky, scrollable avatars -->
  <div class="god-rail-wrap">
    <div class="god-selector-bar" id="god-selector" role="tablist" aria-label="Choose your guide"></div>
  </div>

  <!-- Main card -->
  <div class="valhalla-card" id="valhalla-card">
    <img id="god-logo" alt="God Logo" src=""/>
    <div class="god-title" id="god-title"></div>
    <div class="god-bio" id="god-bio"></div>

    <!-- Ruin Tokens -->
    <div class="ruin-row">
      <span class="rune-coin" aria-hidden="true" title="Fehu — wealth"></span>
      <span>Ruin Tokens Remaining:</span>
      <span id="ruin-tokens">10</span>
    </div>

    <!-- Chat -->
    <div class="chat-history" id="chat-history" aria-live="polite"></div>
    <div class="loader-runic" id="loader-runic" style="display:none;">ᚨ ᛟ ᚱ ᛃ ᚺ ᚠ ᚾ ᛏ</div>

    <form id="chat-form" class="chat-input-row" autocomplete="off">
      <input id="chat-input" class="chat-input" placeholder="Ask your guide anything..." aria-label="Type your question"/>
      <button class="chat-send-btn" type="submit">Send</button>
    </form>

    <!-- Music -->
    <div class="music-player-row" id="music-player">
      <button class="music-play-btn" id="musicPlayBtn" aria-label="Play or pause theme music">🎵</button>
      <input class="music-slider" id="musicSlider" type="range" min="0" max="1" step="0.01" value="0.25" aria-label="Music volume"/>
    </div>

    <!-- Buy Tokens -->
    <button id="buy-tokens-btn" class="buy-btn" onclick="window.location.href='/products/ruin-tokens-pack'">💰 Buy More Tokens</button>
  </div>

  <audio id="musicAudio" loop preload="auto"></audio>

  <script>
  /* ================== GOD DATA (unchanged) ================== */
  const GODS = [
    { key:'odin', name:'Odin', assistantId:'asst_D0BXH8CTZycU0ku9PjkUmW3T',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/mimir-icon.jpg?v=1752795592',
      color:'#1c64ff', music:'https://cdn.pixabay.com/audio/2022/12/19/audio_12b0e71fa2.mp3',
      bio:'Wisdom, vision, and strategy—the Allfather.' },
    { key:'thor', name:'Thor', assistantId:'asst_JNie4vDtknbropUsbuXF4OpG',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Thor_-God-of-Thunder_-Icon.jpg?v=1752622811',
      color:'#e14b3d', music:'https://cdn.pixabay.com/audio/2022/11/16/audio_125b5cfb62.mp3',
      bio:'Strength, action, and resilience—the thunder god.' },
    { key:'loki', name:'Loki', assistantId:'asst_hKdLlIlE66bKCjuuDzhwknFM',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Loki_-God-of-Mischief_-Icon.jpg?v=1752622811',
      color:'#0db18a', music:'https://cdn.pixabay.com/audio/2022/11/16/audio_125b5cfb62.mp3',
      bio:'Creativity, wit, and transformation—the trickster.' },
    { key:'freya', name:'Freya', assistantId:'asst_A0oRwWmYijWwmRJuA2iO9JlR',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Freya_-Icon.jpg?v=1752622811',
      color:'#c5277e', music:'https://cdn.pixabay.com/audio/2022/10/16/audio_125b985df9.mp3',
      bio:'Healing, beauty, and abundance—the goddess of love.' },
    { key:'oz', name:'Oz', assistantId:'asst_Hk4WoxgaWQr5wbagpEtmQbuY',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Oz_-Icon.jpg?v=1752623378',
      color:'#ff9200', music:'https://cdn.pixabay.com/audio/2022/07/26/audio_124b01b0b2.mp3',
      bio:'Transformation, wisdom, and mastery—the digital wizard.' },
    { key:'tyr', name:'Tyr', assistantId:'asst_5RBZdhN1br4dkpDB6g1cRBCg',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/tyr---icon.jpg?v=1752803717',
      color:'#946140', music:'https://cdn.pixabay.com/audio/2023/03/27/audio_1285ba08f4.mp3',
      bio:'Justice, discipline, and sacrifice—the steadfast champion.' },
    { key:'heimdall', name:'Heimdall', assistantId:'asst_5BTp4L16s3LSFZWyOwHL2Qow',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/heimdall_-icon.jpg?v=1752622811',
      color:'#8653eb', music:'https://cdn.pixabay.com/audio/2022/12/19/audio_12b0e71fa2.mp3',
      bio:'Clarity, vigilance, and protection—the ever-watchful guardian.' },
    { key:'skald', name:'Skald', assistantId:'asst_mDsnxmXYWK6VVR2TGlWgr0Db',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Skald_-Icon.jpg?v=1752623003',
      color:'#2b55e2', music:'https://cdn.pixabay.com/audio/2022/10/16/audio_125b985df9.mp3',
      bio:'Story, poetry, and inspiration—the bard of legend.' },
    { key:'coach', name:'Valhalla Coach', assistantId:'asst_0b7Qdwscxs168I4YFX2gKSUd',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Valhalla-Coach-Icon.jpg?v=1752623891',
      color:'#ffe18d', music:'https://cdn.pixabay.com/audio/2023/01/31/audio_12dbfc3fa1.mp3',
      bio:'Motivation, discipline, and action—your ultimate Viking coach.' }
  ];

  /* ================== STATE & ELEMENTS ================== */
  const godSelector = document.getElementById('god-selector');
  const godLogo = document.getElementById('god-logo');
  const godTitle = document.getElementById('god-title');
  const godBio = document.getElementById('god-bio');
  const chatHistoryDiv = document.getElementById('chat-history');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const loaderRunic = document.getElementById('loader-runic');

  const musicAudio = document.getElementById('musicAudio');
  const musicPlayer = document.getElementById('music-player');
  const musicPlayBtn = document.getElementById('musicPlayBtn');
  const musicSlider = document.getElementById('musicSlider');

  function setThemeColor(hex){
    document.documentElement.style.setProperty('--default-color', hex || '#ffe18d');
  }

  // Case-insensitive ?god=
  const urlParams = new URLSearchParams(window.location.search);
  const godParam = (urlParams.get('god')||'').toLowerCase();
  const matched = GODS.find(g => g.key.toLowerCase() === godParam);
  let selectedGod = matched || GODS.find(g=>g.key==='coach') || GODS[0];

  let chatHistory = [];

  /* ================== RENDER ================== */
  function renderGodSelector(list = GODS){
    godSelector.innerHTML = '';
    list.forEach(god=>{
      const avatar = document.createElement('div');
      avatar.className = 'god-avatar' + (selectedGod.key===god.key ? ' selected' : '');
      avatar.title = god.name;
      avatar.style.borderColor = (selectedGod.key===god.key) ? god.color : '#333';
      avatar.setAttribute('role','tab');
      avatar.setAttribute('aria-selected', selectedGod.key===god.key ? 'true':'false');
      avatar.setAttribute('tabindex','0');
      avatar.setAttribute('aria-label', `Select ${god.name}`);

      // Hover glow should match that god's color: use inline var during hover/selected
      avatar.addEventListener('mouseenter', ()=> setThemeColor(god.color));
      avatar.addEventListener('mouseleave', ()=> setThemeColor(selectedGod.color));

      avatar.onclick = ()=> selectGod(god);
      avatar.onkeydown = (e)=>{
        if (e.key==='Enter' || e.key===' ') { e.preventDefault(); selectGod(god); }
      };

      const img = document.createElement('img');
      img.src = god.avatar; img.alt = god.name; img.loading='lazy';
      avatar.appendChild(img);
      godSelector.appendChild(avatar);
    });
  }

  function selectGod(god){
    selectedGod = god;
    setThemeColor(god.color);
    renderGodSelector();
    renderGod();
    chatHistory = [];
    renderChat();
    setupMusic();
  }

  function renderGod(){
    godLogo.src = selectedGod.avatar;
    godTitle.textContent = selectedGod.name;
    godBio.textContent = selectedGod.bio;
    chatInput.placeholder = `Ask ${selectedGod.name} anything...`;
    setThemeColor(selectedGod.color);
  }

  function renderChat(){
    chatHistoryDiv.innerHTML = '';
    chatHistory.forEach(msg=>{
      const d = document.createElement('div');
      d.className = 'chat-msg ' + (msg.from==='user' ? 'user' : 'god');
      const html = marked.parse(msg.text || '', { mangle:false, headerIds:false });
      d.innerHTML = html;
      chatHistoryDiv.appendChild(d);
    });
    // Natural flow; no forced scroll into view to avoid inner scrolling feel
  }

  /* ================== LOADER ================== */
  const runes = ['ᚨ','ᛟ','ᚱ','ᛃ','ᚺ','ᚠ','ᚾ','ᛏ'];
  let runeIdx=0, loaderInterval=null;
  function showLoader(){
    loaderRunic.style.display='';
    loaderRunic.textContent = runes[runeIdx];
    loaderInterval = setInterval(()=>{
      runeIdx = (runeIdx+1) % runes.length;
      loaderRunic.textContent = runes[runeIdx];
    },170);
  }
  function hideLoader(){
    loaderRunic.style.display='none';
    clearInterval(loaderInterval);
  }

  /* ================== MUSIC ================== */
  function setupMusic(){
    if(!selectedGod.music){
      musicPlayer.style.display='none';
      musicAudio.pause();
      return;
    }
    musicPlayer.style.display='';
    musicAudio.src = selectedGod.music;
    musicAudio.volume = parseFloat(musicSlider.value || '0.25');
    musicAudio.pause();
    musicPlayBtn.classList.remove('active');
    musicPlaying = false;
  }
  let musicPlaying = false;
  musicPlayBtn.onclick = ()=>{
    if(!musicPlaying){
      musicAudio.muted=false;
      musicAudio.play().then(()=>{
        musicPlayBtn.classList.add('active'); musicPlaying = true;
      }).catch(()=>{});
    }else{
      musicAudio.pause(); musicPlayBtn.classList.remove('active'); musicPlaying=false;
    }
  };
  musicSlider.oninput = (e)=>{ musicAudio.volume = parseFloat(e.target.value || '0.25'); };
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState==='visible' && musicPlaying){
      musicAudio.play().catch(()=>{});
    }
  });

  /* ================== THREAD + CHAT (endpoints unchanged) ================== */
  function getThreadId(godKey){
    const key = `valhalla_thread_${godKey}`;
    let id = localStorage.getItem(key);
    if(id && id.startsWith('thread_')) return Promise.resolve(id);

    return fetch('https://odin-assistant-starter.vercel.app/api/start-thread', {
      method:'POST', headers:{'Content-Type':'application/json'}
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.threadId && data.threadId.startsWith('thread_')){
        localStorage.setItem(key, data.threadId);
        return data.threadId;
      }else{ throw new Error('Invalid threadId'); }
    })
    .catch(err=>{ console.error('Thread ID error:', err); return null; });
  }

  chatForm.onsubmit = async (e)=>{
    e.preventDefault();
    const remaining = decrementToken();
    if(remaining <= 0){ showTokenModal(); return; }

    const text = chatInput.value.trim();
    if(!text) return;

    chatHistory.push({from:'user', text});
    renderChat();
    chatInput.value='';
    showLoader();

    try{
      const threadId = await getThreadId(selectedGod.key);
      if(!threadId) throw new Error('No thread ID');

      const res = await fetch('https://odin-assistant-starter.vercel.app/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          assistantId: selectedGod.assistantId,
          message: text,
          threadId: threadId
        })
      });
      const data = await res.json();
      hideLoader();
      chatHistory.push({from:'god', text: data.reply || 'No reply from the gods.'});
      renderChat();
    }catch(err){
      hideLoader();
      chatHistory.push({from:'god', text:'⚠️ Network error. Please try again.'});
      renderChat();
    }
  };

  /* ================== TOKENS (kept) ================== */
  const DAILY_LIMIT = 10;
  const TOKEN_KEY = "valhalla_tokens";
  const DATE_KEY = "valhalla_last_date";
  const RITUALS_KEY = "valhalla_rituals_done";

  function getToday(){ return new Date().toISOString().slice(0,10); }
  function resetDailyTokens(){
    localStorage.setItem(TOKEN_KEY, DAILY_LIMIT);
    localStorage.setItem(DATE_KEY, getToday());
    localStorage.setItem(RITUALS_KEY, JSON.stringify({}));
    updateTokenDisplay();
  }
  function updateTokenDisplay(){
    const tokens = parseInt(localStorage.getItem(TOKEN_KEY)) || 0;
    const el = document.getElementById('ruin-tokens');
    if(el) el.textContent = tokens;
  }
  function decrementToken(){
    let tokens = parseInt(localStorage.getItem(TOKEN_KEY)) || 0;
    if(tokens > 0){
      tokens--;
      localStorage.setItem(TOKEN_KEY, tokens);
      // subtle pulse on change
      const el = document.getElementById('ruin-tokens');
      if(el){ el.style.transition='transform .18s'; el.style.transform='scale(1.12)'; setTimeout(()=>{ el.style.transform=''; }, 180); }
    }
    updateTokenDisplay();
    return tokens;
  }
  function addToken(amount=1){
    let tokens = parseInt(localStorage.getItem(TOKEN_KEY)) || 0;
    tokens += amount;
    localStorage.setItem(TOKEN_KEY, tokens);
    updateTokenDisplay();
  }
  function checkReset(){
    const last = localStorage.getItem(DATE_KEY);
    if(last !== getToday()) resetDailyTokens();
  }
  function showTokenModal(){
    alert("🛑 You’re out of Ruin Tokens. Come back tomorrow or earn more through gameplay.");
  }

  // Ritual handling (kept)
  document.addEventListener('DOMContentLoaded', ()=>{
    checkReset(); updateTokenDisplay();
    const saved = JSON.parse(localStorage.getItem(RITUALS_KEY) || "{}");
    document.querySelectorAll('.ritual-check').forEach(cb=>{
      const key = cb.value;
      if(saved[key]) cb.checked = true;
      cb.addEventListener('change', ()=>{
        if(cb.checked && !saved[key]){
          addToken(1);
          saved[key] = true;
          localStorage.setItem(RITUALS_KEY, JSON.stringify(saved));
        }
      });
    });
  });

  /* ================== INIT ================== */
  renderGodSelector();
  renderGod();
  renderChat();
  setupMusic();
  chatInput.focus();
  </script>
</body>
</html>
