<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <meta charset="utf-8"/>
  <title>Valhalla Pantheon ‚Äì Valhalla Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400|Inter:400,700&display=swap" rel="stylesheet"/>

  <style>
  /* ================== THEME & SIZING ================== */
  :root{
    --default-color:#ffe18d;                  /* selected god‚Äôs color (card theme) */
    --font-main:'Montserrat','Inter',sans-serif;

    /* Card tuned shorter per your note (you‚Äôll stretch iframe height in Shopify) */
    --card-w: clamp(560px, 78vw, 980px);
    --card-pad: 32px 24px 20px 24px;
    --card-min-h: clamp(600px, 72vh, 900px);

    --title-size: clamp(1.8rem, 2.4vw, 3rem);
    --bio-size: clamp(1.05rem, 1.25vw, 1.2rem);
    --chat-size: clamp(1rem, 1.15vw, 1.12rem);

    /* Carousel avatars */
    --avatar-w: 96px;     /* bigger faces */
    --avatar-h: 96px;
    --avatar-img: 82px;

    /* Reply band (‚âà 1 inch on most screens, with sane bounds) */
    --reply-min-h: clamp(96px, 14vh, 160px);
  }

  /* Make the iframe background see-through if parent allows it */
  html, body { height:100%; background: transparent; }
  body{
    margin:0; padding:0 0 40px 0;
    color:#f8e6c3; font-family:var(--font-main);
    display:flex; flex-direction:column; align-items:center; gap:0;
  }

  /* ================== FULL-WIDTH OVAL CAROUSEL ================== */
  .carousel-wrap{
    position: sticky; top: 0; z-index: 6;
    width: 100vw; left: 50%; transform: translateX(-50%);
    padding: 10px 0 14px 0;
    backdrop-filter: blur(2px);
    /* fade/taper at edges */
    -webkit-mask-image: linear-gradient(90deg, transparent, #000 8%, #000 92%, transparent);
            mask-image: linear-gradient(90deg, transparent, #000 8%, #000 92%, transparent);
  }
  .carousel{
    position: relative;
    width: 100%;
    height: max(var(--avatar-h), 110px);
    overflow: visible;            /* we animate items, no scrollbar */
    touch-action: pan-y;          /* allow vertical page scroll, we handle horizontal drag */
    cursor: grab;
  }
  .carousel:active{ cursor: grabbing; }

  .car-item{
    --hover-color:#ffe18d;        /* set inline per-god */
    position: absolute; top: 50%; left: 50%;
    width: var(--avatar-w); height: var(--avatar-h);
    transform: translate(-50%,-50%);
    border-radius: 999px;
    display: grid; place-items: center;
    border: 3px solid #333;
    background: #000;
    transition: border-color .18s ease;
    will-change: transform, filter, opacity;
  }
  .car-item img{
    width: var(--avatar-img); height: var(--avatar-img);
    border-radius: 50%; object-fit: cover; object-position: top center;
    background:#181818; display:block;
    pointer-events: none;
  }
  .car-item:hover{
    border-color: var(--hover-color);
    box-shadow: 0 0 18px 2px color-mix(in srgb, var(--hover-color) 55%, transparent);
  }
  .car-item.selected{
    border-color: var(--default-color) !important;
    box-shadow: 0 0 22px 3px color-mix(in srgb, var(--default-color) 65%, transparent);
  }

  /* ================== CARD ================== */
  .valhalla-card{
    border: 2.5px solid var(--default-color);
    border-radius: 32px;
    width: min(98vw, var(--card-w));
    margin: 20px auto 0 auto;
    padding: var(--card-pad);
    min-height: var(--card-min-h);
    background: rgba(20,20,20,.72);     /* subtle glass so outer page shows through */
    box-shadow:
      0 18px 64px color-mix(in srgb, var(--default-color) 18%, #000),
      inset 0 0 80px rgba(255,255,255,.03);
    display: flex; flex-direction: column; align-items: center;
    position: relative; isolation: isolate;
    animation: fadeIn .7s ease;
  }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(18px);} to{opacity:1; transform:translateY(0);} }

  #god-logo{
    width: 136px; height: 136px; border-radius: 50%;
    object-fit: cover; object-position: top center;
    border: 3px solid var(--default-color);
    margin: 8px 0 10px 0;
    box-shadow: 0 0 14px 2px color-mix(in srgb, var(--default-color) 38%, transparent);
  }
  .god-title{
    font-size: var(--title-size);
    letter-spacing: 2px; font-weight:700; text-align:center;
    color: var(--default-color); margin: 8px 0 4px 0;
    text-shadow: 0 2px 16px #0002;
  }
  .god-bio{
    font-size: var(--bio-size); text-align:center; color:#f3ebd7;
    margin: 0 0 8px 0;
  }

  /* ================== RUIN TOKENS ================== */
  .ruin-row{
    display:flex; align-items:center; gap:10px;
    font-weight:bold; color:#FFD700; margin: 6px 0 12px 0;
  }
  .rune-coin{
    width:26px; height:26px; border-radius:50%;
    display:inline-grid; place-items:center;
    border:2px solid #FFD700;
    background: radial-gradient(circle at 30% 30%, #fff2a8 0%, #ffd76c 36%, #b88a2a 70%, #926f22 100%);
    box-shadow: 0 0 10px #ffd76c44, inset 0 0 4px #0008;
    animation: runeSpin 6s linear infinite;
    font-size: 16px; color:#4e3b00; font-family: "Inter", sans-serif;
    user-select:none;
  }
  .rune-coin::before{ content: "·ö†"; } /* Fehu */
  @keyframes runeSpin{ to{ transform: rotate(1turn); } }
  .rune-coin:hover{ box-shadow: 0 0 14px #ffd76c88, inset 0 0 6px #0009; transform: scale(1.04); }

  /* ================== CHAT (reply band is transparent window) ================== */
  .chat-history{
    width:100%;
    min-height: var(--reply-min-h);
    background: transparent;             /* show page/card behind */
    border: 0;
    border-radius: 14px;
    padding: 8px 4px;
    font-size: var(--chat-size);
    margin: 6px 0 6px 0;
    box-shadow: none;                     /* no box so it reads as space */
  }
  .chat-msg{ margin-bottom:10px; padding:.2em 0; text-shadow: 0 1px 2px rgba(0,0,0,.55); }
  .chat-msg.user{ text-align:right; color:#cfeaff; }
  .chat-msg.god{ text-align:left; color:var(--default-color); }
  .chat-msg.god strong{ color:var(--default-color); }
  .chat-msg.god em{ color:#ffdea0; font-style:italic; }
  .chat-msg.god ul{ margin:8px 0 8px 22px; padding-left:0; }
  .chat-msg.god li{ margin-bottom:4px; }

  .loader-runic{
    margin: 2px auto .2em auto; font-size:1.6em; letter-spacing:.19em;
    color:var(--default-color); animation: spinRunes 1.3s linear infinite;
    text-align:center; user-select:none;
  }
  @keyframes spinRunes{ 100%{ transform: rotate(1turn); } }

  .chat-input-row{
    display:flex; width:100%; gap:10px; margin-top:10px; align-items:center;
    box-sizing: border-box;
  }
  .chat-input{
    flex:1; min-width: 0; padding:12px 16px;
    border-radius:22px; border:none; outline:none;
    background:#222; color:#fff9ec; font-size:1.06rem;
    font-family:'Inter',sans-serif; box-shadow: 0 1px 8px #0004;
  }
  .chat-send-btn{
    background:var(--default-color); color:#232323;
    border:none; border-radius:24px;
    padding:12px 20px; font-size:1.02rem; font-weight:700; font-family:'Montserrat',sans-serif;
    cursor:pointer; transition: background .16s, color .12s, transform .12s;
    box-shadow: 0 1px 8px #0003; flex: 0 0 auto;
  }
  .chat-send-btn:hover{ background:#fff6dc; color:var(--default-color); transform: translateY(-1px); }

  /* Mobile: stack input + button so nothing hangs outside */
  @media (max-width: 640px){
    .chat-input-row{ flex-direction: column; align-items: stretch; }
    .chat-send-btn{ width:100%; }
  }

  /* ================== MUSIC ================== */
  .music-player-row{
    width:100%; display:flex; align-items:center; justify-content:center; gap:12px;
    background:#181818aa; border:1px solid #2a2a2a; border-radius:13px;
    padding:8px 10px; margin:10px 0 0 0; box-sizing: border-box;
  }
  .music-play-btn{
    background:none; border:none; cursor:pointer; font-size:1.62em; color:var(--default-color);
    transition: color .16s, transform .13s;
  }
  .music-play-btn.active, .music-play-btn:hover{
    box-shadow: 0 0 8px var(--default-color); color:#fff6dc; transform: scale(1.12) rotate(-7deg);
  }
  .music-slider{ flex:1; accent-color:var(--default-color); margin-left:3px; }
  .music-slider::-webkit-slider-thumb{
    background:#ffe18d; border:none; height:14px; width:14px; border-radius:50%; cursor:pointer; margin-top:-4px;
  }
  .music-slider::-webkit-slider-runnable-track{ background:#444; height:6px; border-radius:3px; }

  /* ================== BUY TOKENS ================== */
  .buy-btn{
    margin: 12px auto 0 auto; background:#1a1a1a; color:#FFD700;
    padding:10px 16px; border:2px solid #FFD700; border-radius:10px; font-weight:bold; display:block; cursor:pointer;
  }
  .buy-btn:hover{ filter: brightness(1.06); }
  </style>
</head>

<body>
  <!-- Full-width, smooth ‚Äúoval‚Äù carousel -->
  <div class="carousel-wrap">
    <div class="carousel" id="godCarousel" aria-label="Choose your guide"></div>
  </div>

  <!-- Main card -->
  <div class="valhalla-card" id="valhalla-card">
    <img id="god-logo" alt="God Logo" src=""/>
    <div class="god-title" id="god-title"></div>
    <div class="god-bio" id="god-bio"></div>

    <!-- Ruin Tokens -->
    <div class="ruin-row">
      <span class="rune-coin" aria-hidden="true" title="Fehu ‚Äî wealth"></span>
      <span>Ruin Tokens Remaining:</span>
      <span id="ruin-tokens">10</span>
    </div>

    <!-- Chat -->
    <div class="chat-history" id="chat-history" aria-live="polite"></div>
    <div class="loader-runic" id="loader-runic" style="display:none;">·ö® ·õü ·ö± ·õÉ ·ö∫ ·ö† ·öæ ·õè</div>

    <form id="chat-form" class="chat-input-row" autocomplete="off">
      <input id="chat-input" class="chat-input" placeholder="Ask your guide anything..." aria-label="Type your question"/>
      <button class="chat-send-btn" type="submit">Send</button>
    </form>

    <!-- Music -->
    <div class="music-player-row" id="music-player">
      <button class="music-play-btn" id="musicPlayBtn" aria-label="Play or pause theme music">üéµ</button>
      <input class="music-slider" id="musicSlider" type="range" min="0" max="1" step="0.01" value="0.25" aria-label="Music volume"/>
    </div>

    <!-- Buy Tokens -->
    <button id="buy-tokens-btn" class="buy-btn" onclick="window.location.href='/products/ruin-tokens-pack'">üí∞ Buy More Tokens</button>
  </div>

  <audio id="musicAudio" loop preload="auto"></audio>

  <script>
  /* ================== GOD DATA (unchanged) ================== */
  const GODS = [
    { key:'odin', name:'Odin', assistantId:'asst_D0BXH8CTZycU0ku9PjkUmW3T',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/mimir-icon.jpg?v=1752795592',
      color:'#1c64ff', music:'https://cdn.pixabay.com/audio/2022/12/19/audio_12b0e71fa2.mp3',
      bio:'Wisdom, vision, and strategy‚Äîthe Allfather.' },
    { key:'thor', name:'Thor', assistantId:'asst_JNie4vDtknbropUsbuXF4OpG',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Thor_-God-of-Thunder_-Icon.jpg?v=1752622811',
      color:'#e14b3d', music:'https://cdn.pixabay.com/audio/2022/11/16/audio_125b5cfb62.mp3',
      bio:'Strength, action, and resilience‚Äîthe thunder god.' },
    { key:'loki', name:'Loki', assistantId:'asst_hKdLlIlE66bKCjuuDzhwknFM',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Loki_-God-of-Mischief_-Icon.jpg?v=1752622811',
      color:'#0db18a', music:'https://cdn.pixabay.com/audio/2022/11/16/audio_125b5cfb62.mp3',
      bio:'Creativity, wit, and transformation‚Äîthe trickster.' },
    { key:'freya', name:'Freya', assistantId:'asst_A0oRwWmYijWwmRJuA2iO9JlR',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Freya_-Icon.jpg?v=1752622811',
      color:'#c5277e', music:'https://cdn.pixabay.com/audio/2022/10/16/audio_125b985df9.mp3',
      bio:'Healing, beauty, and abundance‚Äîthe goddess of love.' },
    { key:'oz', name:'Oz', assistantId:'asst_Hk4WoxgaWQr5wbagpEtmQbuY',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Oz_-Icon.jpg?v=1752623378',
      color:'#ff9200', music:'https://cdn.pixabay.com/audio/2022/07/26/audio_124b01b0b2.mp3',
      bio:'Transformation, wisdom, and mastery‚Äîthe digital wizard.' },
    { key:'tyr', name:'Tyr', assistantId:'asst_5RBZdhN1br4dkpDB6g1cRBCg',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/tyr---icon.jpg?v=1752803717',
      color:'#946140', music:'https://cdn.pixabay.com/audio/2023/03/27/audio_1285ba08f4.mp3',
      bio:'Justice, discipline, and sacrifice‚Äîthe steadfast champion.' },
    { key:'heimdall', name:'Heimdall', assistantId:'asst_5BTp4L16s3LSFZWyOwHL2Qow',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/heimdall_-icon.jpg?v=1752622811',
      color:'#8653eb', music:'https://cdn.pixabay.com/audio/2022/12/19/audio_12b0e71fa2.mp3',
      bio:'Clarity, vigilance, and protection‚Äîthe ever-watchful guardian.' },
    { key:'skald', name:'Skald', assistantId:'asst_mDsnxmXYWK6VVR2TGlWgr0Db',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Skald_-Icon.jpg?v=1752623003',
      color:'#2b55e2', music:'https://cdn.pixabay.com/audio/2022/10/16/audio_125b985df9.mp3',
      bio:'Story, poetry, and inspiration‚Äîthe bard of legend.' },
    { key:'coach', name:'Valhalla Coach', assistantId:'asst_0b7Qdwscxs168I4YFX2gKSUd',
      avatar:'https://cdn.shopify.com/s/files/1/0620/9958/7203/files/Valhalla-Coach-Icon.jpg?v=1752623891',
      color:'#ffe18d', music:'https://cdn.pixabay.com/audio/2023/01/31/audio_12dbfc3fa1.mp3',
      bio:'Motivation, discipline, and action‚Äîyour ultimate Viking coach.' }
  ];

  /* ================== ELEMENTS & STATE ================== */
  const car = document.getElementById('godCarousel');
  const godLogo = document.getElementById('god-logo');
  const godTitle = document.getElementById('god-title');
  const godBio = document.getElementById('god-bio');
  const chatHistoryDiv = document.getElementById('chat-history');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const loaderRunic = document.getElementById('loader-runic');

  const musicAudio = document.getElementById('musicAudio');
  const musicPlayer = document.getElementById('music-player');
  const musicPlayBtn = document.getElementById('musicPlayBtn');
  const musicSlider = document.getElementById('musicSlider');

  function setThemeColor(hex){
    document.documentElement.style.setProperty('--default-color', hex || '#ffe18d');
  }

  // ?god= selection (case-insensitive)
  const urlParams = new URLSearchParams(window.location.search);
  const godParam = (urlParams.get('god')||'').toLowerCase();
  let selectedGod = GODS.find(g => g.key.toLowerCase() === godParam) || GODS.find(g=>g.key==='coach') || GODS[0];

  let chatHistory = [];

  /* ================== OVAL CAROUSEL (requestAnimationFrame) ================== */
  const items = [];
  let current = 0;                 // fractional position
  let speed = 0.003;               // auto-rotate speed (slow & smooth)
  const spacing = 1;               // logical spacing between items
  let dragging = false, lastX = 0, vx = 0;

  function buildCarousel(){
    car.innerHTML = '';
    GODS.forEach((g, idx)=>{
      const d = document.createElement('div');
      d.className = 'car-item';
      if (g.key === selectedGod.key) d.classList.add('selected');
      d.style.setProperty('--hover-color', g.color);
      d.setAttribute('role','button');
      d.setAttribute('aria-label', `Select ${g.name}`);
      d.tabIndex = 0;

      const img = document.createElement('img');
      img.src = g.avatar; img.alt = g.name; img.loading = 'lazy';
      d.appendChild(img);

      d.addEventListener('click', ()=> selectGod(g));
      d.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') selectGod(g); });

      items.push({el:d, idx});
      car.appendChild(d);
    });
  }

  function layoutCarousel(){
    const rect = car.getBoundingClientRect();
    const cx = rect.width/2, cy = rect.height/2;

    const R = Math.min(rect.width, 1000) * 0.38;   // horizontal radius
    const ry = Math.min(rect.height, 180) * 0.18;  // small vertical wobble for oval illusion

    const N = items.length;
    for (let k=0; k<N; k++){
      const it = items[k];
      // position along ellipse using angle = (index - current) * step
      const step = (2*Math.PI)/N;
      const angle = (k - current) * step;

      const x = cx + R * Math.sin(angle);
      const y = cy + ry * Math.cos(angle);         // subtle vertical shift

      // scale and opacity taper toward edges
      const depth = (Math.cos(angle)+1)/2;         // 0..1 (front=1)
      const scale = 0.78 + 0.32 * depth;           // 0.78..1.10
      const alpha = 0.55 + 0.45 * depth;           // 0.55..1
      const blur = 2 * (1 - depth);                // slight edge blur

      it.el.style.transform = `translate(${x - rect.width/2}px, ${y - rect.height/2}px) scale(${scale})`;
      it.el.style.opacity = alpha.toFixed(3);
      it.el.style.filter = `blur(${blur.toFixed(2)}px)`;
      it.el.style.zIndex = (100 + Math.round(depth*100)).toString();
      it.el.classList.toggle('selected', GODS[k].key === selectedGod.key);
    }
  }

  function tick(){
    if (!dragging) current += speed;
    else current += -vx * 0.015;     // convert drag velocity to movement

    // keep current in 0..N
    const N = items.length;
    if (current >= N) current -= N;
    if (current < 0) current += N;

    layoutCarousel();
    requestAnimationFrame(tick);
  }

  // basic drag for manual control
  car.addEventListener('pointerdown', (e)=>{
    dragging = true; lastX = e.clientX; vx = 0;
    car.setPointerCapture(e.pointerId);
  });
  car.addEventListener('pointermove', (e)=>{
    if (!dragging) return;
    const dx = e.clientX - lastX;
    lastX = e.clientX;
    vx = dx;                        // store velocity
    current -= dx / 160;            // sensitivity
  });
  function endDrag(e){ dragging = false; vx = 0; if (e && e.pointerId) { try{car.releasePointerCapture(e.pointerId);}catch{} } }
  car.addEventListener('pointerup', endDrag);
  car.addEventListener('pointercancel', endDrag);
  car.addEventListener('pointerleave', ()=>{ dragging=false; vx=0; });

  /* ================== RENDER & SELECT ================== */
  function renderGod(){
    godLogo.src = selectedGod.avatar;
    godTitle.textContent = selectedGod.name;
    godBio.textContent = selectedGod.bio;
    setThemeColor(selectedGod.color);
  }

  function renderChat(){
    chatHistoryDiv.innerHTML = '';
    chatHistory.forEach(msg=>{
      const d = document.createElement('div');
      d.className = 'chat-msg ' + (msg.from==='user' ? 'user' : 'god');
      const html = marked.parse(msg.text || '', { mangle:false, headerIds:false });
      d.innerHTML = html;
      chatHistoryDiv.appendChild(d);
    });
  }

  function selectGod(g){
    selectedGod = g;
    renderGod();
    renderChat();   // optional: keep history or clear; your call
  }

  /* ================== LOADER ================== */
  const runes = ['·ö®','·õü','·ö±','·õÉ','·ö∫','·ö†','·öæ','·õè'];
  let runeIdx=0, loaderInterval=null;
  function showLoader(){
    loaderRunic.style.display='';
    loaderRunic.textContent = runes[runeIdx];
    loaderInterval = setInterval(()=>{
      runeIdx = (runeIdx+1) % runes.length;
      loaderRunic.textContent = runes[runeIdx];
    },170);
  }
  function hideLoader(){ loaderRunic.style.display='none'; clearInterval(loaderInterval); }

  /* ================== MUSIC ================== */
  function setupMusic(){
    if(!selectedGod.music){
      musicPlayer.style.display='none';
      musicAudio.pause(); return;
    }
    musicPlayer.style.display='';
    musicAudio.src = selectedGod.music;
    musicAudio.volume = parseFloat(musicSlider.value || '0.25');
    musicAudio.pause();
    musicPlayBtn.classList.remove('active');
    musicPlaying = false;
  }
  let musicPlaying = false;
  musicPlayBtn.onclick = ()=>{
    if(!musicPlaying){
      musicAudio.muted=false;
      musicAudio.play().then(()=>{ musicPlayBtn.classList.add('active'); musicPlaying = true; }).catch(()=>{});
    }else{
      musicAudio.pause(); musicPlayBtn.classList.remove('active'); musicPlaying=false;
    }
  };
  musicSlider.oninput = (e)=>{ musicAudio.volume = parseFloat(e.target.value || '0.25'); };
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && musicPlaying){ musicAudio.play().catch(()=>{}); } });

  /* ================== THREAD + CHAT (endpoints unchanged) ================== */
  function getThreadId(godKey){
    const key = `valhalla_thread_${godKey}`;
    let id = localStorage.getItem(key);
    if(id && id.startsWith('thread_')) return Promise.resolve(id);

    return fetch('https://odin-assistant-starter.vercel.app/api/start-thread', {
      method:'POST', headers:{'Content-Type':'application/json'}
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.threadId && data.threadId.startsWith('thread_')){
        localStorage.setItem(key, data.threadId);
        return data.threadId;
      }else{ throw new Error('Invalid threadId'); }
    })
    .catch(err=>{ console.error('Thread ID error:', err); return null; });
  }

  chatForm.onsubmit = async (e)=>{
    e.preventDefault();
    const remaining = decrementToken();
    if(remaining <= 0){ showTokenModal(); return; }

    const text = chatInput.value.trim();
    if(!text) return;

    chatHistory.push({from:'user', text});
    renderChat();
    chatInput.value='';
    showLoader();

    try{
      const threadId = await getThreadId(selectedGod.key);
      if(!threadId) throw new Error('No thread ID');

      const res = await fetch('https://odin-assistant-starter.vercel.app/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          assistantId: selectedGod.assistantId,
          message: text,
          threadId: threadId
        })
      });
      const data = await res.json();
      hideLoader();
      chatHistory.push({from:'god', text: data.reply || 'No reply from the gods.'});
      renderChat();
    }catch(err){
      hideLoader();
      chatHistory.push({from:'god', text:'‚ö†Ô∏è Network error. Please try again.'});
      renderChat();
    }
  };

  /* ================== TOKENS (kept) ================== */
  const DAILY_LIMIT = 10;
  const TOKEN_KEY = "valhalla_tokens";
  const DATE_KEY = "valhalla_last_date";
  const RITUALS_KEY = "valhalla_rituals_done";

  function getToday(){ return new Date().toISOString().slice(0,10); }
  function resetDailyTokens(){ localStorage.setItem(TOKEN_KEY, DAILY_LIMIT); localStorage.setItem(DATE_KEY, getToday()); localStorage.setItem(RITUALS_KEY, JSON.stringify({})); updateTokenDisplay(); }
  function updateTokenDisplay(){ const tokens = parseInt(localStorage.getItem(TOKEN_KEY)) || 0; const el = document.getElementById('ruin-tokens'); if(el) el.textContent = tokens; }
  function decrementToken(){
    let tokens = parseInt(localStorage.getItem(TOKEN_KEY)) || 0;
    if(tokens > 0){
      tokens--; localStorage.setItem(TOKEN_KEY, tokens);
      const el = document.getElementById('ruin-tokens'); if(el){ el.style.transition='transform .18s'; el.style.transform='scale(1.12)'; setTimeout(()=>{ el.style.transform=''; }, 180); }
    }
    updateTokenDisplay(); return tokens;
  }
  function addToken(amount=1){ let tokens = parseInt(localStorage.getItem(TOKEN_KEY)) || 0; tokens += amount; localStorage.setItem(TOKEN_KEY, tokens); updateTokenDisplay(); }
  function checkReset(){ const last = localStorage.getItem(DATE_KEY); if(last !== getToday()) resetDailyTokens(); }
  function showTokenModal(){ alert("üõë You‚Äôre out of Ruin Tokens. Come back tomorrow or earn more through gameplay."); }

  document.addEventListener('DOMContentLoaded', ()=>{
    checkReset(); updateTokenDisplay();
    const saved = JSON.parse(localStorage.getItem(RITUALS_KEY) || "{}");
    document.querySelectorAll('.ritual-check').forEach(cb=>{
      const key = cb.value;
      if(saved[key]) cb.checked = true;
      cb.addEventListener('change', ()=>{
        if(cb.checked && !saved[key]){
          addToken(1);
          saved[key] = true;
          localStorage.setItem(RITUALS_KEY, JSON.stringify(saved));
        }
      });
    });
  });

  /* ================== INIT ================== */
  (function init(){
    buildCarousel();
    renderGod();
    renderChat();
    setupMusic();
    requestAnimationFrame(tick);
    chatInput.focus();
  })();
  </script>
</body>
</html>
