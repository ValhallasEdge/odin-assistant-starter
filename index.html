<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Realm Coach</title>

<style>
:root{
  --bg:#0c151c;--panel:#0f1d27;--line:#27475b;--txt:#eaf7ff;--sub:#cfe8fb;
  --chip:#123345;--chipB:#23536a;--btn:#163043;--btn2:#1b3a4c;--glow:#9fd3ff3a;
  --accent:#9fd3ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:820px;margin:14px auto;padding:12px}
.open{display:inline-block;margin-bottom:10px;background:var(--btn);color:var(--txt);border:1px solid var(--line);
  padding:.62rem 1rem;border-radius:.85rem;cursor:pointer;box-shadow:0 0 0 0 var(--glow);transition:box-shadow .2s,transform .2s}
.open:hover{box-shadow:0 0 26px 2px var(--glow);transform:translateY(-1px)}
.panel{position:relative;border:1px solid var(--line);border-radius:18px;background:var(--panel);box-shadow:0 10px 42px #0009;overflow:hidden}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:linear-gradient(180deg,#132330,#0e1a23);border-bottom:1px solid var(--line)}
.title{font-weight:800;letter-spacing:.4px}
.close{background:transparent;border:1px solid var(--line);color:var(--sub);border-radius:.6rem;padding:.25rem .6rem;cursor:pointer}
.brief{padding:.75rem 1rem;border-bottom:1px dashed var(--line);color:var(--sub)}
.suggest{display:flex;flex-wrap:wrap;gap:.5rem;padding:.6rem 1rem;border-bottom:1px dashed var(--line)}
.chip{background:var(--chip);border:1px solid var(--chipB);color:var(--sub);padding:.38rem .65rem;border-radius:.6rem;cursor:pointer}
.chat{display:flex;flex-direction:column;gap:.6rem;max-height:58vh;overflow:auto;padding:1rem}
.msg{padding:.65rem .8rem;border-radius:.8rem;line-height:1.45;box-shadow:0 1px 6px rgba(0,0,0,.25)}
.bot{background:#122737;border:1px solid #23455a}
.you{background:#12323d;border:1px solid #235861;margin-left:auto}
.form{display:grid;gap:.6rem;padding:0 1rem 1rem}
textarea{background:#0a1720;color:var(--txt);border:1px solid #25465a;border-radius:.8rem;padding:.6rem .75rem;min-height:86px;resize:vertical}
.send{justify-self:end;background:var(--btn2);color:var(--txt);border:1px solid #2e5d76;border-radius:.7rem;padding:.55rem .95rem;cursor:pointer}
@media (max-width:640px){ .chat{max-height:64vh} }

/* cinematic particles (disabled for reduced-motion) */
@media (prefers-reduced-motion:no-preference){
  .panel::before, .panel::after{
    content:"";position:absolute;inset:-20% -10% auto -10%;height:40%;pointer-events:none;mix-blend-mode:screen;opacity:.55;
    background: radial-gradient(120px 60px at 10% 60%, #9fd3ff22, transparent 60%),
                radial-gradient(160px 80px at 85% 20%, #9fd3ff14, transparent 60%),
                radial-gradient(100px 60px at 50% 90%, #9fd3ff10, transparent 60%);
    animation: drift 22s linear infinite;
    filter: blur(1.1px);
  }
  .panel::after{ animation-duration: 28s; opacity:.35; }
  @keyframes drift{ to{ transform: translateY(-14%) } }

  .runes{position:absolute;inset:0;pointer-events:none;color:#9fd3ff18;font-size:42px;letter-spacing:.42em;filter:blur(.4px);
    animation: float 18s linear infinite}
  @keyframes float{ to { transform: translate3d(0,-10%,0) } }
}
</style>
</head>
<body>
<div class="wrap">
  <button class="open" id="openBtn">Consult your Realm Guide</button>

  <section class="panel" id="panel" role="dialog" aria-modal="true" hidden>
    <div class="runes" aria-hidden="true">ᚠᚢᚦᚨᚱᚲ ᚷᚹᚺᚾᛁ ᛃᛇᛈᛉᛊ</div>
    <header class="hdr">
      <div class="title" id="title">Realm Guide</div>
      <button class="close" id="closeBtn" aria-label="Close">×</button>
    </header>

    <div class="brief" id="brief">Waiting for your realm stats…</div>

    <div class="suggest">
      <button class="chip" data-q="Give me a safe 7‑day plan based on my logs.">7‑day plan</button>
      <button class="chip" data-q="Why is my streak stalling and how do I fix it?">Fix a stall</button>
      <button class="chip" data-q="Coach me on breathwork/recovery for this realm.">Breathwork</button>
      <button class="chip" data-q="Set a ritual adventure for this week.">Ritual adventure</button>
    </div>

    <div class="chat" id="chat" role="log" aria-live="polite"></div>

    <form class="form" id="form">
      <textarea id="input" placeholder="Ask your guide…" required></textarea>
      <label style="color:#a9c7da;font-size:.9rem">
        <input type="checkbox" id="attach" checked> Attach my stats
      </label>
      <button class="send" type="submit">Send</button>
    </form>
  </section>
</div>

<script>
(()=>{
  // --------- Params (assistant & realm) ---------
  const p = new URLSearchParams(location.search);
  const assistantId = p.get('assistantId') || '';        // REQUIRED
  const realm = (p.get('realm') || 'frost').toLowerCase();

  // --------- UI refs ---------
  const title = document.getElementById('title');
  const brief = document.getElementById('brief');
  const chat  = document.getElementById('chat');
  const form  = document.getElementById('form');
  const input = document.getElementById('input');
  const attach= document.getElementById('attach');
  const panel = document.getElementById('panel');
  const openBtn = document.getElementById('openBtn');
  const closeBtn= document.getElementById('closeBtn');

  // Title per realm (feel free to tweak names)
  const realmTitle = {
    frost:'Frost Guide', fire:'Fire Keeper', runes:'Skald — Runes Guide',
    feast:'Freyja — Feast Guide', fitness:'Thor — Fitness Guide', brave:'Týr — BRAVE Guide'
  }[realm] || 'Realm Guide';
  title.textContent = realmTitle;

  // a11y open/close
  openBtn.addEventListener('click',()=>{ panel.hidden=false; openBtn.setAttribute('aria-expanded','true'); input.focus(); });
  closeBtn.addEventListener('click',()=>{ panel.hidden=true;  openBtn.setAttribute('aria-expanded','false'); openBtn.focus(); });
  panel.addEventListener('keydown',e=>{ if(e.key==='Escape') closeBtn.click(); });

  // chips
  document.querySelectorAll('.chip').forEach(c=> c.addEventListener('click',()=>{ input.value=c.dataset.q; input.focus(); }));

  // --------- Data from parent via postMessage ---------
  let realmLogs = [];   // array of this realm's entries (e.g., frostRituals)
  let masterRaw = null; // optional cross-realm snapshot

  // Accept stats from parent page (Shopify, etc.)
  window.addEventListener('message',(ev)=>{
    const d = ev.data || {};
    if(d.type === 've-stats' && d.realm && d.logs){
      realmLogs = Array.isArray(d.logs) ? d.logs : [];
      masterRaw = d.master || null;
      renderBrief();
    }
  });

  function addMsg(t,who='bot'){
    const el=document.createElement('div');
    el.className='msg '+(who==='you'?'you':'bot');
    el.textContent=t;
    chat.appendChild(el);
    chat.scrollTop=chat.scrollHeight;
  }

  // --------- Summaries ----------
  function parseTemp(raw){
    if(raw==null) return null;
    const n = parseFloat(String(raw).replace(',','.'));
    return Number.isFinite(n)? n : null;
  }

  function summarize(realm, logs){
    if(!Array.isArray(logs) || logs.length===0) return null;
    const last7 = logs.slice(-7);
    const sum = (arr,sel)=> arr.reduce((a,x)=> a+(+sel(x)||0), 0);
    const avg = (arr,sel)=> sum(arr,sel)/Math.max(1,arr.length);

    const durKey = 'duration'; // all your samples use "duration" minutes
    const tempSel = (realm==='frost' || realm==='fire') ? (l=>parseTemp(l.tempRaw)) : (()=>null);

    const avgDur  = +(avg(last7, l=> l[durKey]).toFixed(1));
    const someTemp = tempSel(last7[0])!=null;
    const avgTemp = someTemp ? +(avg(last7, tempSel).toFixed(1)) : null;
    const last = logs[logs.length-1];

    // streak = ≥1 entry per calendar date
    const dates = new Set(logs.map(l => (l.isoDate || new Date(l.timestamp).toISOString().slice(0,10))));
    let streak=0; for(;;){ const d=new Date(); d.setDate(d.getDate()-streak); const key=d.toISOString().slice(0,10); if(dates.has(key)) streak++; else break; }

    return { sessions: logs.length, avgDur7: avgDur, avgTemp7: avgTemp, last, streak };
  }

  function renderBrief(){
    const s = summarize(realm, realmLogs);
    if(!s){ brief.textContent = 'No recent sessions found — your guide will start you gently.'; return; }
    const tempPart = (s.avgTemp7!=null) ? ` • 7d avg temp: ${s.avgTemp7}°` : '';
    brief.textContent = `Sessions: ${s.sessions} • 7d avg duration: ${s.avgDur7} min${tempPart} • Streak: ${s.streak}d`;
  }

  // --------- Threads ----------
  const threadKey = (assistantId)=> `valhalla_thread_${assistantId}`;
  async function getThread(){
    let id = localStorage.getItem(threadKey(assistantId));
    if(id && id.startsWith('thread_')) return id;
    const r = await fetch('/api/start-thread',{method:'POST',headers:{'Content-Type':'application/json'}});
    const j = await r.json();
    if(j.threadId){ localStorage.setItem(threadKey(assistantId), j.threadId); return j.threadId; }
    throw new Error('No threadId');
  }

  // --------- Prompt ----------
  function buildPrompt(q){
    const s = attach.checked ? summarize(realm, realmLogs) : null;
    const master = attach.checked ? (masterRaw || null) : null;

    const safety = {
      frost:'Emphasize gradual cold exposure, breathwork, and medical caution. Avoid extremes.',
      fire:'Emphasize heat safety, hydration, cooldown. Avoid extremes.',
      runes:'Mindfulness and breath practices; non-clinical guidance.',
      feast:'General nutrition rituals only; no medical claims.',
      fitness:'Progressive overload, recovery, joint safety.',
      brave:'Discipline and ethical framing; non-clinical.'
    }[realm] || 'Be safe and practical.';

    const rules = `You are the ${realmTitle}. Tone: calm, stoic, practical, mythic edge. ${safety}
Respond concisely with: (1) brief reflection, (2) 2–3 numbered steps with specific targets, (3) one optional stretch, (4) a safety reminder.`;

    const realmBlock = s ? `
[Realm Summary]
Sessions: ${s.sessions}
7-day avg duration: ${s.avgDur7} min${s.avgTemp7!=null?`\n7-day avg temp: ${s.avgTemp7}°`:''}
Streak: ${s.streak} days
Last: ${(s.last?.isoDate)|| (s.last?.timestamp) || 'n/a'} — duration ${s.last?.duration||'n/a'} min${s.last?.tempRaw?`, temp ${s.last.tempRaw}`:''}
` : `[No realm data — give a gentle beginner path]`;

    const masterBlock = master ? `\n[Master Snapshot]\n${JSON.stringify(master).slice(0, 900)}` : '';

    const question = q || 'Guide me for this week based on my logs.';

    return `${rules}\n${realmBlock}${masterBlock}\n\n[User]\n${question}`;
  }

  // --------- Send ----------
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const q = input.value.trim();
    if(!q) return;
    addMsg(q,'you'); input.value=''; addMsg('Consulting your guide…');
    try{
      if(!assistantId) throw new Error('Missing assistantId');
      const threadId = await getThread();
      const r = await fetch('/api/chat',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ assistantId, message: buildPrompt(q), threadId })
      });
      const j = await r.json();
      chat.lastChild.textContent = j.reply || '…';
    }catch(err){
      console.error(err);
      chat.lastChild.textContent = 'The guide is silent. Try again soon.';
    }
  });

  // initial
  renderBrief();
})();
</script>
</body>
</html>
