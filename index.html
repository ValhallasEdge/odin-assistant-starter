<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ask Odin | Valhalla AI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Valhalla's Edge Odin AI: Norse-inspired wisdom, fitness, and legacy. Ask Odin your question—get cinematic, actionable answers." />
  <!-- Montserrat for modern body, UnifrakturCook for subtle rune header -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-charcoal: #181b1e;
      --secondary-charcoal: #32343a;
      --softer-charcoal: #45464b;
      --rune-blue: #32495a;
      --mist-blue: #e6e9ee;
      --viking-burgundy: #47212b;
      --faint-white: #fcfdff;
      --msg-bg: #f7f8fa;
      --heading-weight: 700;
      --body-weight: 400;
    }
    html, body {
      background: linear-gradient(132deg, var(--faint-white) 64%, var(--mist-blue) 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', 'Georgia', serif;
      color: var(--primary-charcoal);
    }
    body::before {
      content: "";
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: url('https://www.transparenttextures.com/patterns/clouds.png'), linear-gradient(120deg, #eaecef 70%, #d3d8e2 100%);
      opacity: 0.13;
      filter: blur(0.8px);
      pointer-events: none;
      z-index: 0;
    }
    .chat-wrapper {
      max-width: 780px;
      margin: 68px auto 48px auto;
      background: rgba(255,255,255,0.94);
      border-radius: 2.2em;
      box-shadow: 0 12px 48px 0 #232b3722, 0 2px 22px #3b3f4533, 0 0.5px 4px #181b1e07;
      padding: 2.6em 2.3em 2.1em 2.3em;
      border: 1.5px solid #eceef4;
      backdrop-filter: blur(5.5px) saturate(1.15);
      transition: box-shadow 0.45s cubic-bezier(.17,.67,.83,.67), transform 0.5s cubic-bezier(.12,.57,.88,1.18);
      position: relative;
      z-index: 1;
    }
    .chat-wrapper:hover, .chat-wrapper:focus-within {
      box-shadow: 0 24px 64px 0 #232b3744, 0 1.5px 32px #a7bdd6aa, 0 2px 20px 0 #232b3722, 0 12px 40px 8px #a3bbce12;
      transform: translateY(-7px) scale(1.012);
    }
    /* HEADER */
    .valhalla-header {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 0.5em;
    }
    .runes-bg {
      position: absolute;
      top: 19px; left: 50%;
      transform: translateX(-50%);
      font-family: 'UnifrakturCook', serif;
      color: #c9ccd4;
      font-size: 2.8em;
      letter-spacing: 0.45em;
      opacity: 0.14;
      pointer-events: none;
      z-index: 0;
      user-select: none;
      white-space: nowrap;
    }
    .header-title {
      position: relative;
      z-index: 1;
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-size: 2.7em;
      font-weight: var(--heading-weight);
      letter-spacing: 1.1px;
      color: var(--primary-charcoal);
      margin: 0.11em 0 0.16em 0;
      text-shadow: 0 1px 12px #d9dde7bb;
    }
    .norse-underline {
      width: 82px;
      height: 4px;
      margin: -16px auto 24px auto;
      background: linear-gradient(90deg, var(--secondary-charcoal), var(--mist-blue) 90%);
      border-radius: 2px;
      opacity: 0.23;
      box-shadow: 0 0 16px #a7bbce13;
    }
    /* LOADER */
    #loader {
      display: none;
      text-align: center;
      margin: 1.1em 0 1.12em 0;
      color: var(--softer-charcoal);
      font-style: italic;
      font-size: 1.09em;
      font-family: 'Montserrat', serif;
      letter-spacing: 0.02em;
      transition: opacity 0.34s;
    }
    .loader-rune {
      display: inline-block;
      font-family: 'UnifrakturCook', serif;
      font-size: 2em;
      color: var(--rune-blue);
      margin-right: 10px;
      vertical-align: middle;
      filter: drop-shadow(0 0 8px #a3bbce77);
      animation: runespin 2.1s linear infinite;
    }
    @keyframes runespin {
      0% { transform: rotateY(0);}
      80% { filter: drop-shadow(0 0 16px #bfc5da44);}
      100% { transform: rotateY(360deg);}
    }
    .loader-dots::after {
      content: '';
      display: inline-block;
      width: 1em;
      text-align: left;
      animation: ellipsis steps(4,end) 1.16s infinite;
    }
    @keyframes ellipsis {
      to { width: 4em; }
    }
    /* CHAT */
    .chat-box {
      height: 420px;
      overflow-y: auto;
      border-radius: 1.5em;
      padding: 1.3em 2.2em 1.45em 1.6em;
      background: var(--msg-bg);
      margin-bottom: 1.6em;
      box-shadow: 0 0 12px #c9ccd411, 0 0.5px 7px #7a7b8b13;
      border: 1.5px solid #eceef4;
      scroll-behavior: smooth;
      position: relative;
      transition: box-shadow 0.4s;
    }
    .msg {
      opacity: 0;
      animation: fadeIn 0.48s forwards;
      margin-bottom: 1.1em;
      line-height: 1.65;
    }
    @keyframes fadeIn {
      from { opacity: 0;}
      to   { opacity: 1;}
    }
    .msg.user {
      color: var(--primary-charcoal);
      background: linear-gradient(97deg, #f7f7f7 80%, #e3e7ee 100%);
      border-radius: 10px 21px 16px 10px;
      padding: 0.78em 1.22em 0.9em 1.16em;
      font-weight: var(--heading-weight);
      margin: 0.7em 0 0.7em 38%;
      border-left: 2.5px solid var(--rune-blue);
      box-shadow: 1px 2px 10px #bfc5da12;
      word-break: break-word;
      font-size: 1.06em;
    }
    .msg.odin {
      color: var(--softer-charcoal);
      background: linear-gradient(100deg, #fdfdfe 94%, #e3e7ee 100%);
      font-style: normal;
      border-left: 4px solid var(--rune-blue);
      padding: 1.1em 1.35em 1.1em 1.38em;
      margin: 0.7em 31% 0.7em 0;
      border-radius: 19px 13px 13px 24px;
      box-shadow: 2px 4px 19px #bfc5da1a;
      word-break: break-word;
      font-size: 1.14em;
      font-family: 'Montserrat', serif;
      position: relative;
      overflow: visible;
      transition: box-shadow 0.6s;
    }
    /* Odin headings and bullets */
    .msg.odin strong,
    .msg.odin h1,
    .msg.odin h2,
    .msg.odin h3,
    .msg.odin h4,
    .msg.odin h5,
    .msg.odin h6 {
      color: var(--secondary-charcoal);
      font-weight: var(--heading-weight);
      font-family: 'Montserrat', serif;
      letter-spacing: 0.2px;
      margin: 0.77em 0 0.4em 0;
      text-shadow: 0 0 6px #d2d5db09;
      line-height: 1.23;
    }
    .msg.odin ul, .msg.odin ol {
      margin: 0.8em 0 0.8em 2.1em;
    }
    .msg.odin em {
      color: var(--viking-burgundy);
      font-style: italic;
      font-weight: var(--body-weight);
    }
    .msg.odin code {
      font-family: monospace;
      background: #ededf5;
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--rune-blue);
      font-size: 1em;
    }
    .msg.odin hr {
      border: none;
      border-top: 1.5px solid #bfc5da44;
      margin: 1.2em 0;
    }
    .msg.odin a {
      color: var(--rune-blue);
      text-decoration: underline dotted;
      transition: color 0.2s;
    }
    .msg.odin a:hover {
      color: var(--viking-burgundy);
    }
    /* Subtle fog animation (desktop only, Odin reply) */
    .msg.odin:hover::before {
      content: '';
      pointer-events: none;
      position: absolute;
      left: -7%; right: -7%; top: -11%; bottom: -10%;
      z-index: 2;
      background: radial-gradient(circle at 56% 60%, #bfc5da23 42%, #f7fafb0a 92%);
      opacity: 0.65;
      animation: fog-move 2.2s linear infinite alternate;
      filter: blur(9px) brightness(1.11);
    }
    @keyframes fog-move {
      from { background-position: 52% 56%;}
      to   { background-position: 48% 44%;}
    }
    .input-area {
      display: flex;
      gap: 1em;
      margin-top: 1.1em;
      align-items: center;
    }
    .input-area input {
      flex: 1;
      padding: 1.18em;
      font-size: 1.12em;
      border: 2.2px solid #bfc5da;
      border-radius: 14px;
      background: #f6f8fa;
      outline: none;
      transition: border 0.23s, box-shadow 0.3s;
      box-shadow: 0 1.5px 10px #bfc5da19;
      color: var(--secondary-charcoal);
      font-weight: var(--body-weight);
    }
    .input-area input:focus {
      border: 2.8px solid var(--rune-blue);
      box-shadow: 0 0 7px #adadc7;
    }
    .input-area button {
      padding: 1.09em 2.21em;
      font-size: 1.12em;
      background: linear-gradient(to right, var(--secondary-charcoal), #bfc5da);
      color: #fff;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 1.5px 10px #bfc5da19;
      letter-spacing: 0.09em;
      transition: background 0.3s, box-shadow 0.3s;
      font-family: inherit;
    }
    .input-area button:hover {
      background: linear-gradient(to right, #3a4151, #e5e6e8 100%);
      box-shadow: 0 6px 16px #adadc7a1;
      color: var(--primary-charcoal);
    }
    @media (max-width: 700px) {
      .chat-wrapper { padding: 0.6em 0.5vw;}
      .chat-box { height: 245px;}
      .header-title { font-size: 1.4em;}
      .norse-underline { width: 50px;}
      .runes-bg { font-size: 1.22em; top: 13px;}
      .input-area input, .input-area button { font-size: 0.98em; padding: 1em;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="chat-wrapper">
    <div class="valhalla-header">
      <!-- Runes behind title (subtle) -->
      <div class="runes-bg">ᚨᚱᚢᛟ ᚨᛁ</div>
      <span class="header-title">Ask Odin</span>
    </div>
    <div class="norse-underline"></div>
    <div id="chat" class="chat-box" aria-live="polite"></div>
    <div id="loader">
      <span class="loader-rune">ᚨ</span>
      Odin is searching the Well of Wisdom<span class="loader-dots">...</span>
    </div>
    <div class="input-area">
      <input id="user-input" type="text" placeholder="Ask your question..." onkeydown="if(event.key==='Enter'){sendMessage()}" autocomplete="off" aria-label="Ask your question to Odin" />
      <button onclick="sendMessage()" aria-label="Send message to Odin">SEND</button>
    </div>
  </div>
<script>
  async function sendMessage() {
    const input = document.getElementById('user-input');
    const chat = document.getElementById('chat');
    const loader = document.getElementById('loader');
    const userText = input.value.trim();
    if (!userText) return;

    // Always use a new thread (no memory)
    let threadId = null;
    localStorage.removeItem('odinThreadId'); // just in case

    // User message markup
    chat.innerHTML += `<div class="msg user">You: ${escapeHTML(userText)}</div>`;
    input.value = '';
    chat.scrollTop = chat.scrollHeight;

    // Show loader
    loader.style.display = 'block';

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userText, threadId })
      });

      const data = await response.json();

      // Hide loader
      loader.style.display = 'none';

      if (data.reply) {
        chat.innerHTML += `<div class="msg odin">${marked.parse(data.reply)}</div>`;
      } else if (data.error) {
        chat.innerHTML += `<div class="msg odin">Odin: ERROR - ${escapeHTML(data.error)}</div>`;
      } else {
        chat.innerHTML += `<div class="msg odin">Odin: (No response from Valhalla...)</div>`;
      }
    } catch (err) {
      loader.style.display = 'none';
      console.error(err);
      chat.innerHTML += `<div class="msg odin">Odin: (NETWORK ERROR: ${escapeHTML(err.message)})</div>`;
    }

    chat.scrollTop = chat.scrollHeight;
  }
  // Escape HTML for user input/output
  function escapeHTML(str) {
    return (str || '').replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }
</script>
</body>
</html>
